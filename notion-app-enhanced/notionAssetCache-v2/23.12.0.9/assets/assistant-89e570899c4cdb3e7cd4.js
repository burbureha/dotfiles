"use strict";(self.webpackChunknotion_next=self.webpackChunknotion_next||[]).push([[8721],{11462:(t,e,o)=>{o.d(e,{cz:()=>j,G6:()=>B,vR:()=>D,CU:()=>$,mA:()=>P});var r=o(96486),n=o.n(r),i=o(26263),a=o(1302),s=o(78395);class l{constructor(t){this.state=void 0,this.state=t}async eval(t){const{input:e,commit:o}=t,r=this.cloneState(),n=[];try{const t=this.state.parse(e);for(const e of t)if("element"===e.type)if(s.Mc[e.tagName]){const t=s.Mc[e.tagName]({attributes:e.attributes||{},children:e.children||[],state:r});t&&n.push(t)}else{if(!s.LI[e.tagName])throw new Error(`Unknown API: ${e.tagName}`);{const t=await s.LI[e.tagName]({attributes:e.attributes,children:e.children,state:r});t&&n.push(t)}}return o&&(this.state=r),{type:"success",out:n.join("\n")}}catch(i){return{type:"error",error:`${i.name}: ${i.message}`}}}cloneState(){return{...this.state,selection:this.state.selection?n().cloneDeep(this.state.selection):void 0,blockIdMap:(0,s.SC)(this.state.blockIdMap)}}}function c(t){const e=[[/"/,'"'],[/'/,"'",/(^|[^\p{L}\p{M}])/],[/`/,"`"],[/\(/,")"],[/\[/,"]"],[/\{/,"}"],[/\\\*/,"*/"],[/<([a-z0-9-]+)( [a-z0-9-]+="[^"]*")*>/,"</$1>"]].map((t=>{let[{source:e},o,{source:r}={source:!1}]=t;return[new RegExp(`^${e}[^]*`,"u"),o,r&&new RegExp(`${r}$`,"u")]})),o=[];let r=0;t:for(;r<t.length;){const n=t.slice(r),i=o.at(-1);if(i&&n.startsWith(i))o.pop(),r+=i.length;else{for(const[i,a,s]of e)if(i.test(n)&&(!s||s.test(t.slice(0,r)))){o.push(n.replace(i,a)),r+=1;continue t}r+=1}}return t+o.reverse().join("")}class d{constructor(t){this.transcript=[],this.codeEvaluator=void 0,this.counter=0,this.streamInference=void 0,this.streamInference=t.streamInference,this.codeEvaluator=new l(t)}getTranscript(){return this.transcript}async*sampleNextStep(){const t=this.streamInference(this.getTranscript()),e=this.counter++;let o="";for await(const r of t)o+=r,yield{type:"assistant",id:e,value:c(o)}}async simulateStep(t){if("assistant"===t.type||"human"===t.type){return await this.evaluateStep(t,!1)}}async commitStep(t){if(this.transcript=[...this.transcript,t],"assistant"===t.type||"human"===t.type){const e=await this.evaluateStep(t,!0);return e&&(this.transcript=[...this.transcript,e]),e}}createAssistantStep(t){return{id:this.counter++,type:"assistant",value:t}}createHumanStep(t){return{id:this.counter++,type:"human",value:t}}async evaluateStep(t,e){const o=await this.codeEvaluator.eval({input:t.value,commit:e});return"success"!==o.type?{type:"observation",id:this.counter++,observationType:"error",value:o.error}:o.out?{type:"observation",id:this.counter++,observationType:"output",value:o.out}:void 0}}function p(t){let e="";for(let o=0;o<t.length;o++){const r=t[o],n=t[o-1];if("human"===r.type)e+=`\n\nHuman: ${r.value.trim()}`;else if("observation"===r.type)if("output"===r.observationType)e+=`\n<stdout>${r.value.trim()}</stdout>`;else{if("error"!==r.observationType)throw new Error("Unknown observation type");e+=`\n<stderr>${r.value.trim()}</stderr>`}else{if("assistant"!==r.type)throw new Error("Unknown step type");e+=!n||"human"===n.type?`\n\nAssistant: ${r.value.trim()}`:`\n${r.value.trim()}`}}return e.trim()}var u=o(97880);class m{constructor(){this.counter=0,this.uuidToCounterMap=new Map,this.counterToUUidMap=new Map}mapUUIDToCounter(t){if(!this.uuidToCounterMap.has(t)){const e=this.counter.toString();this.uuidToCounterMap.set(t,e),this.counterToUUidMap.set(e,t),this.counter++}return this.uuidToCounterMap.get(t)}mapNodeUUIDToCounter(t){const e={...t};return"block"===e.type?(e.id=this.mapUUIDToCounter(e.id),e.attributes=this.mapNodeAttributesUUIDToCounter(e.attributes),e.children=e.children.map((t=>{const o=this.mapNodeUUIDToCounter(t);return o.parent=e,o})),e):"property"===e.type||"inline"===e.type?(e.attributes=this.mapNodeAttributesUUIDToCounter(e.attributes),e.children=e.children.map((t=>this.mapNodeUUIDToCounter(t))),e):"text"===e.type?e:void(0,u.t1)(e)}mapNodeAttributesUUIDToCounter(t){if(!t)return t;const e={...t};for(const o of m.attributesToMap)e[o]&&(e[o]=this.mapUUIDToCounter(e[o]));return e}mapCounterToUUID(t){const e=this.counterToUUidMap.get(t);if(!e)throw new Error(`Tried to map invalid id: ${t}`);return e}mapNodeCounterToUUID(t){const e={...t};return"block"===e.type?(e.id=this.mapCounterToUUID(e.id),e.attributes=this.mapNodeAttributesCounterToUUID(e.attributes),e.children=e.children.map((t=>{const o=this.mapNodeCounterToUUID(t);return o.parent=e,o})),e):"property"===e.type||"inline"===e.type?(e.attributes=this.mapNodeAttributesCounterToUUID(e.attributes),e.children=e.children.map((t=>this.mapNodeCounterToUUID(t))),e):"text"===e.type?e:void(0,u.t1)(e)}mapNodeAttributesCounterToUUID(t){if(!t)return t;const e={...t};return null!=e&&e.id&&(e.id=this.mapCounterToUUID(e.id)),e}mapAssistantOperationCounterToUUID(t){if("createBlock"===t.command){const e=t.blockNode;return{...t,blockNode:{...e,id:this.mapCounterToUUID(e.id),text:e.text.map((t=>this.mapNodeCounterToUUID(t))),children:e.children.map((t=>this.mapNodeCounterToUUID(t))),attributes:this.mapNodeAttributesCounterToUUID(e.attributes),parent:e.parent&&this.mapNodeCounterToUUID(e.parent)}}}if("removeBlock"===t.command)return{...t,parentId:this.mapCounterToUUID(t.parentId),removeId:this.mapCounterToUUID(t.removeId)};if("insertBlockBefore"===t.command)return{...t,parentId:this.mapCounterToUUID(t.parentId),insertId:this.mapCounterToUUID(t.insertId),beforeId:t.beforeId?this.mapCounterToUUID(t.beforeId):void 0};if("insertBlockAfter"===t.command)return{...t,parentId:this.mapCounterToUUID(t.parentId),insertId:this.mapCounterToUUID(t.insertId),afterId:t.afterId?this.mapCounterToUUID(t.afterId):void 0};if("setBlockText"===t.command)return{...t,id:this.mapCounterToUUID(t.id)};if("setBlockAttribute"===t.command)return{...t,id:this.mapCounterToUUID(t.id)};if("setBlockTagName"===t.command)return{...t,id:this.mapCounterToUUID(t.id)};throw new Error("Invalid operation")}}m.attributesToMap=["id","page-id","database-id","person-id"];var h=o(88891),f=o(24993),b=o(65917),v=o(74229),w=o(4615),g=o(21202),y=o(19889),k=o(95477),I=o(33929),E=o(95802),U=o(79315),C=o(44653),S=(o(12318),o(50906)),N=o(54642),_=o(73928),x=o(47307),O=o(61045),M=o(24677),T=o(30149);async function $(t){var e;const{environment:o,store:r}=t;null!==(e=r.state)&&void 0!==e&&e.temporaryCache&&r.state.temporaryCache.clearCache(),r.set({sessionId:(0,w.ZP)(),clientSteps:[],sampledSteps:[],previewingStep:void 0,previewingStepIndex:void 0,previewingStepObservation:void 0,evaluator:new d({selection:void 0,blockIdMap:{},streamInference:async function*(t){const{currentSpaceStore:e}=U.default.state;if(!e)throw new Error("No current space.");const n=await N.getCompletion(o,{id:(0,w.ZP)(),context:{type:"assistant",transcript:t},model:"anthropic-2",spaceId:e.id,isSpacePermission:!1,debugOverrides:{returnDebugInfo:!0,ignoreRateLimit:!0}});if("success"!==n.type)return(0,x.showError)(n),{type:"error_modal_shown"};if(v.H1.is(n.data))for await(const o of n.data)if("success"===o.type){if(o.debugRenderedPrompt){if(!r.state)return;r.set({...r.state,samplingPrompt:o.debugRenderedPrompt})}yield o.completion}else if("error"===o.type)throw new Error(o.message)},parse:t=>(0,f.P5)(t),addOperation:t=>{if(!r.state)throw new Error("No state");const e=r.state.idMapper.mapAssistantOperationCounterToUUID(t),n=o.currentUser.id;if(!n)throw new Error("No current user.");const i={table:y.KJ,id:n},{inMemoryRecordCache:a}=o.defaultRecordCache;if(!r.state)throw new Error("No state");const{temporaryCache:s,committing:l,transaction:c}=r.state;if(!c)throw new Error("No transaction.");const d=!l?s:a,p=(0,h.N)({assistantOperation:e,actorPointer:i,getRecordValue:d.makeGetRecordValueFn(n)});r.set({...r.state,temporaryOperations:r.state.temporaryOperations.concat(p),temporaryAssistantOperations:r.state.temporaryAssistantOperations.concat(e)});for(const r of p){const t=new C.ST({environment:o,pointer:r.pointer,path:r.path,inMemoryRecordCache:d});T.applyOperation({store:t,operation:r,transaction:c})}},randomID:()=>{if(!r.state)throw new Error("No state");const t=(0,w.ZP)();return r.state.idMapper.mapUUIDToCounter(t)},loadPage:async t=>{if(!r.state)throw new Error("No state");const{mainEditorCurrentBlockStore:e}=U.default.state;if(!e)throw new Error("No current block store");const o={table:g.iU,id:r.state.idMapper.mapCounterToUUID(t),spaceId:e.getSpaceId()},n=await(0,f.IT)({pointer:o,loadRecordValue:e.loadRecordValue,baseUrl:k.Z.domainBaseUrl,publicDomainName:k.Z.publicDomainName,intl:I.default.getIntl()});return r.state.idMapper.mapNodeUUIDToCounter(n)},chat:(t,e)=>{const o=r.state;if(!o)throw new Error("No state");const n={blockIds:t.map((t=>o.idMapper.mapCounterToUUID(t))),operations:e.map((t=>o.idMapper.mapAssistantOperationCounterToUUID(t)))};r.set({...r.state,temporaryClientSteps:[...r.state.temporaryClientSteps,{type:"assistantChat",blockIds:n.blockIds,operations:n.operations}]})}}),initialSteps:[],temporaryOperations:[],temporaryCache:new i.Z,loading:!1,temporaryClientSteps:[],temporaryAssistantOperations:[],samplingPrompt:void 0,idMapper:new m,committing:!1,transaction:void 0});const a=U.default.state.mainEditorCurrentBlockStore;if(a){if(!r.state)throw new Error("No state");const t=r.state.idMapper.mapUUIDToCounter(a.id),e=r.state.evaluator.createAssistantStep(`<load-page id="${t}"></load-page>`),i=await P({environment:o,store:r,step:e,commit:!0,isStreaming:!1});"error"===(null==i?void 0:i.observationType)&&(0,x.showMessage)({message:i.value}),r.set({...r.state,initialSteps:n().compact([e,i])})}}async function B(t){const{environment:e,store:o,message:r}=t;if(!o.state)throw new Error("No state");const{evaluator:n}=o.state;o.set({...o.state,clientSteps:[...o.state.clientSteps,{type:"human",value:r}]});const i=n.createHumanStep(r);await P({environment:e,store:o,step:i,commit:!0,isStreaming:!1}),o.set({...o.state,clientSteps:[...o.state.clientSteps,...o.state.temporaryClientSteps],sampledSteps:[],previewingStep:void 0,previewingStepIndex:void 0,previewingStepObservation:void 0,temporaryOperations:[],temporaryClientSteps:[],temporaryAssistantOperations:[]}),r.includes("<js>")||await A({environment:e,store:o})}async function A(t){const{environment:e,store:o}=t;if(!o.state)throw new Error("No state");const{evaluator:r}=o.state,i=n().range(2);o.set({...o.state,loading:!0,sampledSteps:i.map((t=>({id:t,type:"assistant",value:""})))});const a=i[Math.floor(Math.random()*i.length)],s=n().throttle((async()=>{const t=o.state;if(!t)return;const r=t.sampledSteps[a];await P({environment:e,store:o,step:r,commit:!1,isStreaming:!0})}),_.Z1);try{await Promise.all(i.map((async t=>{const e=r.sampleNextStep();for await(const r of e){if(!o.state)throw new Error("No state");const e=o.state.sampledSteps.map(((e,o)=>o===t?r:e));o.setState({...o.state,sampledSteps:e}),t===a&&s()}})))}catch(l){const t=l.message||JSON.stringify(l)||"Unknown error";(0,x.showMessage)({message:t})}o.set({...o.state,loading:!1})}async function D(t){const{environment:e,store:o}=t;if(!o.state)throw new Error("No state");const{sampledSteps:r,previewingStep:n,samplingPrompt:i,evaluator:a}=o.state,{currentSpaceStore:s,currentUserStore:l}=U.default.state;if(!n)throw new Error("No previewing step");if(!i)throw new Error("No sampling prompt");if(!s)throw new Error("No current space");if(!l)throw new Error("No current user");const c=p(a.getTranscript()),d=await P({environment:e,store:o,step:n,commit:!0,isStreaming:!1});(0,S.trackAssistantFeedback)(e,{prompt:i,transcript:c,option_a:r[0].value,option_b:r[1].value,selected_option:n.id===r[0].id?"a":"b",observation:null==d?void 0:d.value}),N.saveAssistantFeedback(e,{id:(0,w.ZP)(),type:"assistant_feedback",prompt:i,transcript:c,option_a:r[0].value,option_b:r[1].value,selected_option:n.id===r[0].id?"a":"b",observation:null==d?void 0:d.value,space_id:s.id,user_id:l.id,client_version:2}),o.set({...o.state,clientSteps:[...o.state.clientSteps,...o.state.temporaryClientSteps],sampledSteps:[],previewingStep:void 0,previewingStepIndex:void 0,previewingStepObservation:void 0,temporaryOperations:[],temporaryClientSteps:[],temporaryAssistantOperations:[]}),d&&await A(t)}function j(t){const{store:e}=t;if(!e.state)throw new Error("No state");const{temporaryCache:o}=e.state;o.clearCache(),e.set({...e.state,temporaryOperations:[],temporaryClientSteps:[],temporaryAssistantOperations:[],previewingStep:void 0,previewingStepIndex:void 0,previewingStepObservation:void 0})}async function P(t){const{environment:e,store:o,step:r,commit:i,isStreaming:s}=t,l=e.currentUser.id;if(!l)throw new Error("No current user.");if(!o.state)throw new Error("No state");const{evaluator:c,temporaryCache:d}=o.state,{inMemoryRecordCache:u}=e.defaultRecordCache;d.clearCache(),d.cacheUsingThisInstanceAsAnOverride||u.addCacheOverride(d),o.set({...o.state,temporaryOperations:[],temporaryClientSteps:[],temporaryAssistantOperations:[],committing:i});const{performResult:m}=await T.createAndCommitAsync({environment:e,async perform(t){if(!o.state)throw new Error("No state.");o.set({...o.state,transaction:t});const e=await(i?c.commitStep(r):c.simulateStep(r));if("error"===(null==e?void 0:e.observationType)&&i)throw new Error(`Encountered error while committing step: ${e.value}`);return e},waitForServerCommit:!1,userAction:"assistantActions.simulateOrCommitStep",userId:l}),h="error"===(null==m?void 0:m.observationType);if(h&&o.state.temporaryCache.clearCache(),h&&!s){const t=p(c.getTranscript());b.log({level:"error",from:"assistantActions",type:"assistantStepError",data:{miscDataToConvertToString:{step:r,transcript:t,observation:m}}})}return i||"assistant"!==r.type||o.setState({...o.state,previewingStep:r,previewingStepIndex:o.state.sampledSteps.indexOf(r),previewingStepObservation:m}),!h&&o.state.temporaryAssistantOperations.length>0&&o.set({...o.state,temporaryClientSteps:[...o.state.temporaryClientSteps,{type:"assistantTransaction",operations:o.state.temporaryAssistantOperations}]}),h||a.default.afterNextFlush((()=>{var t;const r=n().compact(null===(t=o.state)||void 0===t?void 0:t.temporaryOperations.map((t=>{let{pointer:e}=t;return e.table===g.iU?e.id:void 0}))),i=E.C.findScrollToSelectablesFromIds(r).map((t=>t.props.store));(0,M.Z5)({environment:e,stores:i}),(0,O.hl)(r,!1)})),m}},16336:(t,e,o)=>{o.r(e),o.d(e,{AssistantButton:()=>z});var r=o(77094),n=o.n(r),i=o(67294),a=o(480),s=o(24405),l=o(3779),c=o(11462),d=o(80863),p=o(64921),u=o(44532),m=o(16489),h=o(82990),f=o(34859),b=o(61519),v=o(1743),w=o(74194),g=o(18647),y=o(72495),k=o(62385),I=o(18466),E=o(26263),U=o(88891),C=o(21202),S=o(19889),N=o(42925),_=o(30149),x=o(44653),O=o(49065),M=o(39760),T=o(17748);function $(t){const{clientStep:e}=t,o=(0,a.O7)(),r=(0,i.useMemo)((()=>I.Z.withListenerIgnored((()=>{const t=new E.Z,r=o.currentUser.id;if(!r)throw new Error("No current user.");const n={table:S.KJ,id:r},i=(0,_.createAndCommit)({userAction:"AssistantChatMessageRenderer.temporaryListStore",environment:o,perform:i=>{for(const s of e.operations){const e=(0,U.N)({assistantOperation:s,actorPointer:n,getRecordValue:t.makeGetRecordValueFn(r)});for(const r of e){const e=new O.ST({environment:o,pointer:r.pointer,path:r.path,inMemoryRecordCache:t});(0,_.applyOperation)({store:e,operation:r,transaction:i})}}const a=e.blockIds.map((e=>new x.G(o,{table:C.iU,id:e},{inMemoryRecordCache:t})));return(0,N.Lh)({environment:o,stores:a,inMemoryRecordCache:t,transaction:i})}}).performResult;return t.addCacheFallback(o.defaultRecordCache.inMemoryRecordCache),i}))),[o,e]);return n()(M.O,{displayName:"AssistantChatStepContent",disabled:!0},void 0,n()(T.Z,{store:r,disabled:!0,disableCommentMenu:!0,disableHoverMenu:!0,disableDrag:!0}))}var B=o(96486),A=o.n(B),D=o(84209);function j(t){const{store:e,clientStep:o}=t,r=A().compact(o.operations.map((t=>"insertBlockAfter"===t.command||"insertBlockBefore"===t.command?t.insertId:void 0))),a=A().compact(o.operations.map((t=>"removeBlock"===t.command?t.removeId:void 0))).filter((t=>!r.includes(t))),s=A().compact(o.operations.map((t=>"setBlockAttribute"===t.command||"setBlockTagName"===t.command||"setBlockText"===t.command?t.id:void 0)));return i.createElement(i.Fragment,null,a.length>0&&i.createElement(i.Fragment,null,n()("div",{},void 0,n()("b",{},void 0,"Removed blocks:")),n()(P,{store:e,blockIds:a})),r.length>0&&i.createElement(i.Fragment,null,n()("div",{},void 0,n()("b",{},void 0,"Inserted blocks:")),n()(P,{store:e,blockIds:r})),s.length>0&&i.createElement(i.Fragment,null,n()("div",{},void 0,n()("b",{},void 0,"Updated blocks:")),n()(P,{store:e,blockIds:s})))}function P(t){const{store:e,blockIds:o}=t,r=(0,a.O7)(),s=(0,i.useMemo)((()=>I.Z.withListenerIgnored((()=>{const t=e.state;if(!t)throw new Error("No state");return o.map((e=>new x.G(r,{table:C.iU,id:e},{inMemoryRecordCache:t.temporaryCache})))}))),[r,o,e]);return n()(M.O,{displayName:"AssistantBlockRenderer",disabled:!0},void 0,s.map(((t,e)=>n()(Z,{store:t},e))))}function Z(t){const{store:e}=t,o=(0,m.VK)((()=>(0,D.h)(e)),[e]);return o?n()(o,{store:e,disabled:!0,isFirstItem:!1,isLastItem:!1}):null}function R(t){const{store:e,clientStep:o}=t,r=(0,s.yK)((t=>({wrap:{display:"flex",marginTop:5,marginBottom:5},baseMessage:{maxWidth:"80%",borderRadius:12,paddingLeft:8,paddingRight:8,paddingTop:6,paddingBottom:6,fontSize:14,whiteSpace:"pre-wrap",overflowWrap:"break-word",position:"relative"},humanMessage:{backgroundColor:t.accentColors.purple[400],color:t.regularInvertedTextColor},assistantMessage:{backgroundColor:t.accentColors.gray[50],color:t.darkTextColor}})),[]);return n()("div",{style:r.wrap},void 0,"human"===o.type&&n()("div",{style:{flexGrow:1}}),n()("div",{style:{...r.baseMessage,..."human"===o.type?r.humanMessage:r.assistantMessage}},void 0,"human"===o.type?o.value:"assistantChat"===o.type?n()($,{clientStep:o}):"assistantTransaction"===o.type?n()(j,{store:e,clientStep:o}):void 0))}var V=o(68785);function F(t){const{store:e,index:o,step:r}=t,l=(0,a.O7)(),p=(0,s.yK)((t=>({input:{marginTop:5,marginBottom:5,fontFamily:h.Z.baseFontFamily.githubMono,fontSize:12},inputInner:{height:150},topbarWrap:{display:"flex"},label:{fontSize:12},blue:{color:t.accentColors.blue[500]}})),[]),u=(0,i.useCallback)((t=>{(0,d.z)({store:e,step:{...r,value:t.target.value}})}),[e,r]),f=(0,i.useCallback)((()=>{(0,c.mA)({environment:l,store:e,step:r,commit:!1,isStreaming:!1})}),[l,e,r]),b=(0,i.useCallback)((()=>{(0,c.cz)({store:e})}),[e]),v=(0,m.VK)((()=>{var t;return null===(t=e.state)||void 0===t?void 0:t.loading}),[e]),g=(0,m.VK)((()=>{var t;return(null===(t=e.state)||void 0===t?void 0:t.previewingStep)===r}),[e,r]);return n()("div",{},void 0,n()("div",{style:p.topbarWrap},void 0,n()("div",{style:p.label},void 0,`Sample ${o+1}`),n()("div",{style:{flexGrow:1}}),!v&&(g?n()(k.Z,{style:p.blue,onClick:b},void 0,"Previewing"):n()(k.Z,{onClick:f},void 0,"Preview")),v&&n()(V.Z,{style:{width:12}})),n()(w.Z,{style:p.input,inputStyle:p.inputInner,value:r.value,onChange:u,textarea:!0,spellCheck:!1}))}function L(t){const{store:e,onClose:o}=t,[r,l]=(0,i.useState)(""),d=(0,i.useRef)(void 0),p=(0,m.VK)((()=>e.state),[e]),u=(0,a.O7)();(0,i.useEffect)((()=>{d.current&&d.current.scrollToBottom()}),[null==p?void 0:p.clientSteps]);const I=(0,s.yK)((t=>({wrap:{width:420,height:"90vh",display:"flex",flexDirection:"column"},topbarWrap:{display:"flex",marginLeft:6,marginRight:6},input:{width:void 0,marginLeft:8,marginRight:8},scroller:{flexGrow:1,paddingTop:8,paddingBottom:8,paddingLeft:8,paddingRight:8,backgroundColor:t.contentBackground},samplesLabel:{fontSize:12,marginTop:8,marginBottom:8},previewLabel:{fontSize:12}})),[]),E=(0,i.useCallback)((async()=>{e.state&&await(0,c.CU)({environment:u,store:e})}),[u,e]),U=(0,i.useCallback)((t=>{l(t.target.value)}),[l]),C=(0,i.useCallback)((()=>{e.state&&(!r||e.state.sampledSteps.length>0||((0,c.G6)({environment:u,store:e,message:r}),l("")))}),[u,r,l,e]),S=(0,i.useCallback)((()=>{(0,c.vR)({environment:u,store:e})}),[u,e]);return n()("div",{style:I.wrap},void 0,n()(y.Z,{},void 0,n()("div",{style:I.topbarWrap},void 0,n()(k.Z,{onClick:E},void 0,"Reset"),n()("div",{style:{flexGrow:1}}),n()(k.Z,{onClick:o},void 0,"Close"))),i.createElement(g.Z,{ref:d,type:f.Z.Y,style:I.scroller},null==p?void 0:p.clientSteps.map(((t,o)=>n()(R,{store:e,clientStep:t},o))),(null==p?void 0:p.sampledSteps)&&p.sampledSteps.length>0&&i.createElement(i.Fragment,null,n()(b.Z,{size:24}),n()("div",{style:I.samplesLabel},void 0,n()("div",{},void 0,n()("b",{},void 0,"Sampling 2 options for the assistant's next step")),n()("div",{},void 0,"Use Preview on each to decide which one is best. You can also make manual edits."),n()("div",{},void 0,"Note: end-users will not be able to see this part.")),null==p?void 0:p.sampledSteps.map(((t,o)=>n()(F,{store:e,index:o,step:t},o)))),(null==p?void 0:p.previewingStep)&&i.createElement(i.Fragment,null,n()(b.Z,{size:24}),n()("div",{style:{display:"flex",marginTop:8,marginBottom:8}},void 0,n()("div",{style:I.previewLabel},void 0,n()("div",{},void 0,n()("b",{},void 0,"Previewing assistant step")),(null==p?void 0:p.previewingStepObservation)&&n()("div",{},void 0,"The assistant executed code that resulted in output. Clicking Accept will show this output to the assistant and allow it to take the next step.")),n()("div",{style:{flexGrow:1}}),n()(k.Z,{onClick:S},void 0,"Accept")),(null==p?void 0:p.previewingStepObservation)&&n()("div",{style:{fontSize:12,fontFamily:h.Z.baseFontFamily.githubMono,whiteSpace:"pre-wrap",overflowWrap:"break-word"}},void 0,null==p?void 0:p.previewingStepObservation.value),null==p?void 0:p.temporaryClientSteps.map(((t,o)=>n()(R,{store:e,clientStep:t},o))))),n()(y.Z,{},void 0,n()(v.Z,{capture:!0},void 0,n()(w.Z,{style:I.input,value:r,placeholder:"Ask a question or ask to modify this pageâ€¦",onChange:U,onSubmit:C,focusInitial:!0}))))}function z(){const t=(0,a.O7)(),[e,o]=(0,i.useState)(!1),r=(0,s.yK)((t=>({button:{position:"absolute",bottom:16,right:62,background:t.inputBackground,color:t.mediumTextColor,fill:t.mediumTextColor,boxShadow:t.borderBoxShadow,display:"flex",alignItems:"center",borderRadius:24,height:36,paddingLeft:10,paddingRight:10,fontSize:14,zIndex:1}})),[]),m=(0,i.useCallback)((async()=>{if(d.o.state||await(0,c.CU)({environment:t,store:d.o}),!d.o.state)throw new Error("No state");o(!0)}),[t,o]),h=(0,i.useCallback)((()=>{o(!1)}),[o]);return n()(u.ZP,{popupType:u.kQ.Popup,open:e,origin:n()(p.Z,{style:r.button,onClick:m},void 0,l.Z.sparkles({width:14,height:14,marginRight:4}),"Ask Notion AI"),originGap:6,disableMouseCapture:!0,render:()=>n()(L,{store:d.o,onClose:h})})}},88828:(t,e,o)=>{o.r(e),o.d(e,{AssistantLabelerBar:()=>h});var r=o(77094),n=o.n(r),i=o(67294),a=o(480),s=o(16489),l=o(24405),c=o(11462),d=o(80863),p=o(68785),u=o(89728),m=o(44532);function h(){const t=(0,a.O7)(),e=(0,l.yK)((t=>({wrap:{padding:8,backgroundColor:t.contentBackground},inner:{display:"flex",alignItems:"center"},error:{fontSize:14,color:t.accentColors.red[600]}})),[]),o=(0,s.VK)((()=>{const t=d.o.state;return Boolean(t&&t.sampledSteps.length>0)}),[]),r=(0,s.VK)((()=>{const t=d.o.state;return Boolean(t&&t.loading)}),[]),h=(0,s.VK)((()=>{const t=d.o.state;return null==t?void 0:t.previewingStepIndex}),[]),f=(0,s.VK)((()=>{const t=d.o.state;return null==t?void 0:t.previewingStepObservation}),[]),b=(0,i.useCallback)((()=>{(0,c.cz)({store:d.o})}),[]),v=(0,i.useCallback)((async e=>{const o=d.o.state;o&&await(0,c.mA)({environment:t,store:d.o,step:o.sampledSteps[e],commit:!1,isStreaming:!1})}),[t]),w=(0,i.useCallback)((async()=>{await(0,c.vR)({environment:t,store:d.o})}),[t]),g=(0,s.VK)((()=>({top:0,left:0,right:0,bottom:0,width:t.WindowSizeStore.state.width,height:0})),[t],{useDeepEqual:!0});return n()(m.ZP,{popupType:m.kQ.Popup,open:o,originRect:g,originGap:6,disableMouseCapture:!0,render:()=>n()("div",{style:e.wrap},void 0,n()("div",{style:e.inner},void 0,n()(u.Z,{hovered:void 0===h||void 0,onClick:b},void 0,"Original"),n()(u.Z,{hovered:0===h||void 0,onClick:()=>v(0)},void 0,"A"),n()(u.Z,{hovered:1===h||void 0,onClick:()=>v(1)},void 0,"B"),n()(u.Z,{disabled:void 0===h,onClick:w},void 0,"Accept"),r&&n()(p.Z,{})),f&&!r&&n()("div",{style:e.error},void 0,"Error: ",f.value))})}},80863:(t,e,o)=>{function r(t){const{store:e,step:o}=t;if(!e.state)throw new Error("No state");const r=e.state.sampledSteps.map((t=>t.id===o.id?o:t));e.set({...e.state,sampledSteps:r})}o.d(e,{z:()=>r,o:()=>n});const n=new(o(12318).default)(void 0)},78395:(t,e,o)=>{o.d(e,{pX:()=>i,t:()=>s,LI:()=>l,Mc:()=>c,SC:()=>E});var r=o(96486),n=o.n(r);const i={hr:{title:!1,content:[],attributes:{},properties:[]},embed:{title:!1,content:[],attributes:{},properties:[]},h1:{title:!0,content:[],attributes:{},properties:[]},h2:{title:!0,content:[],attributes:{},properties:[]},h3:{title:!0,content:[],attributes:{},properties:[]},database:{title:!0,content:[],attributes:{},properties:[]},"math-block":{title:!0,content:[],attributes:{},properties:[]},"code-block":{title:!0,content:[],attributes:{language:{values:!0,description:"language of code"}},properties:[]},"child-page":{title:!0,content:[],attributes:{"page-id":{values:!0,description:"ID of page, to be used in <load-page>"}},properties:[]},"link-page":{title:!0,content:[],attributes:{"page-id":{values:!0,description:"ID of page, to be used in <load-page>"}},properties:[]},"child-database":{title:!0,content:[],attributes:{"database-id":{values:!0,description:"ID of database"}},properties:[]},"link-database":{title:!0,content:[],attributes:{"database-id":{values:!0,description:"ID of database"}},properties:[]},text:{title:!0,content:!0,attributes:{},properties:[]},page:{title:!0,content:!0,attributes:{},properties:[]},uli:{title:!0,content:!0,attributes:{},properties:[]},oli:{title:!0,content:!0,attributes:{},properties:[]},toggle:{title:!0,content:!0,attributes:{},properties:[]},quote:{title:!0,content:!0,attributes:{},properties:[]},todo:{title:!0,content:!0,attributes:{checked:{values:["true","false"],description:'checked state, either "true" or "false"'}},properties:[]},callout:{title:!0,content:!0,attributes:{},properties:[]},columns:{title:!1,content:["column"],attributes:{},properties:[]},column:{title:!1,content:!0,attributes:{},properties:[]},table:{title:!1,content:["tr"],attributes:{"header-row":{values:["true","false"],description:'whether first <tr> is row header, either "true" or "false"'},"header-column":{values:["true","false"],description:'whether first <td> in every <tr> is column header, either "true" or "false"'}},properties:[]},tr:{title:!1,content:[],attributes:{},properties:["property-text"]}},a={"property-text":{content:!0}},s=(Array.from(new Set(Object.values(i).flatMap((t=>Object.keys(t.attributes))))),Object.keys(i),{b:{attributes:{}},i:{attributes:{}},code:{attributes:{}},s:{attributes:{}},u:{attributes:{}},a:{attributes:{href:{values:!0,description:"link URL"}}},"mention-page":{attributes:{"page-id":{values:!0,description:"ID of page"}},isToken:!0},"mention-database":{attributes:{"database-id":{values:!0,description:"ID of database"}},isToken:!0},person:{attributes:{"person-id":{values:!0,description:"ID of person"}},isToken:!0}});Array.from(new Set(Object.values(s).flatMap((t=>Object.keys(t.attributes)))));const l={"load-page":async function(t){const{attributes:e,children:o,state:r}=t;if(o.length>0)throw new Error("<load-page> cannot have children");const{id:n,...i}=e;if(Object.keys(i).length>0)throw new Error(`<load-page> has invalid attributes: ${Object.keys(i).join(", ")}`);if("string"!=typeof n)throw new Error("<load-page> must have an id attribute");const a=await r.loadPage(n),s=[a],l=[];let c;for(;c=s.pop();)l.includes(c.id)||(r.blockIdMap[c.id]=c,s.push(...c.children),l.push(c.id));return function(t){const{node:e,state:o}=t;return w({node:e,state:o}).join("")}({node:a,state:r})}},c={"insert-before":function(t){const{attributes:e,children:o,state:r}=t,{id:n,...i}=e;if(Object.keys(i).length>0)throw new Error(`<insert-before> has invalid attributes: ${Object.keys(i).join(", ")}`);if("string"!=typeof n)throw new Error("Block missing id attribute.");const a=r.blockIdMap[n];if(!a)throw new Error(`Block with id ${n} not found.`);if(!a.parent)throw new Error(`Block with id ${n} has no parent.`);const s=d({children:o,state:r,allowMove:!0});let l;if(k({remove:s,state:r}),l=!a||a.parent.children.indexOf(a)<0?0:a.parent.children.indexOf(a),l<0)throw new Error("Cannot insert before without parent.");y({parent:a.parent,index:l,insert:s,state:r});const c=a?s:[...s].reverse();for(const d of c)r.addOperation({command:"insertBlockBefore",parentId:a.parent.id,insertId:d.id,beforeId:null==a?void 0:a.id})},"insert-after":function(t){const{attributes:e,children:o,state:r}=t,{id:n,...i}=e;if(Object.keys(i).length>0)throw new Error(`<insert-after> has invalid attributes: ${Object.keys(i).join(", ")}`);if("string"!=typeof n)throw new Error("Block missing id attribute.");const a=r.blockIdMap[n];if(!a)throw new Error(`Block with id ${n} not found.`);if(!a.parent)throw new Error(`Block with id ${n} has no parent.`);const s=d({children:o,state:r,allowMove:!0});let l;if(k({remove:s,state:r}),l=0===a.parent.children.length?0:!a||a.parent.children.indexOf(a)<0?a.parent.children.length-1:a.parent.children.indexOf(a),l<0)throw new Error("Cannot insert before without parent.");y({parent:a.parent,index:l+1,insert:s,state:r});const c=a?[...s].reverse():s;for(const d of c)r.addOperation({command:"insertBlockAfter",parentId:a.parent.id,insertId:d.id,afterId:null==a?void 0:a.id})},"insert-inside":function(t){const{attributes:e,children:o,state:r}=t,{id:n,...i}=e;if(Object.keys(i).length>0)throw new Error(`<insert-inside> has invalid attributes: ${Object.keys(i).join(", ")}`);if("string"!=typeof n)throw new Error("Block missing id attribute.");const a=r.blockIdMap[n];if(!a)throw new Error(`Block with id ${n} not found.`);const s=d({children:o,state:r,allowMove:!0});k({remove:s,state:r}),y({parent:a,index:a.children.length+1,insert:s,state:r});const l=[...s].reverse();for(const c of l)r.addOperation({command:"insertBlockAfter",parentId:a.id,insertId:c.id})},delete:function(t){const{attributes:e,children:o,state:r}=t;if(o.length>0)throw new Error("<delete> cannot have children.");const{id:n,...i}=e;if(Object.keys(i).length>0)throw new Error(`<delete> has invalid attributes: ${Object.keys(i).join(", ")}`);if("string"!=typeof n)throw new Error("Block missing id attribute.");const a=r.blockIdMap[n];if(!a)throw new Error(`Block with id ${n} not found.`);k({remove:[a],state:r})},"set-title":function(t){const{attributes:e,children:o,state:r}=t,{id:n,...i}=e;if(Object.keys(i).length>0)throw new Error(`<set-title> has invalid attributes: ${Object.keys(i).join(", ")}`);if("string"!=typeof n)throw new Error("Block missing id attribute.");const a=r.blockIdMap[n];if(!a)throw new Error(`Block with id ${n} not found.`);const s=o.map((t=>"text"===t.type?g({value:t.value}):h(t)));r.addOperation({command:"setBlockText",id:a.id,text:s}),a.text=s},"set-attribute":function(t){const{attributes:e,children:o,state:r}=t;if(o.length>0)throw new Error("<set-attribute> cannot have children.");if("string"!=typeof e.id)throw new Error("Block missing id attribute.");const n=r.blockIdMap[e.id];if(!n)throw new Error(`Block with id ${e.id} not found.`);if(Object.keys(e).length<2)throw new Error(`Attempted to set an attribute without a key: ${Object.keys(e).join(", ")}.`);if(Object.keys(e).length>2)throw new Error(`Attempted to set an attribute with more than one key: ${Object.keys(e).join(", ")}.`);const a=Object.keys(e).find((t=>"id"!==t));if("string"!=typeof a)throw new Error(`Attempted to set a non-string attribute: ${String(a)}.`);const s=e[a];if("string"!=typeof s)throw new Error(`Attempted to set an attribute to a non-string value: ${a}.`);if("id"===a)throw new Error("Attempted to set id attribute.");const l=Object.fromEntries(Object.entries(i[n.tagName].attributes).map((t=>{let[e,{values:o}]=t;return[e,o]})))[a];if(!l)throw new Error(`Attempted to set an attribute that is not allowed: ${a}.`);if(!0!==l&&!l.includes(s))throw new Error(`Attempted to set attribute ${a} to value that is not allowed: ${s}.`);r.addOperation({command:"setBlockAttribute",id:n.id,attribute:a,value:s}),n.attributes[a]=s},"set-tag-name":function(t){const{attributes:e,children:o,state:r}=t;if(o.length>0)throw new Error("<set-tag-name> cannot have children.");const{id:n,"tag-name":a,...s}=e;if(Object.keys(s).length>0)throw new Error(`<set-tag-name> has invalid attributes: ${Object.keys(s).join(", ")}`);if("string"!=typeof n)throw new Error("Block missing id attribute.");const l=r.blockIdMap[n];if(!l)throw new Error(`Block with id ${n} not found.`);if("string"!=typeof a)throw new Error(`Invalid argument type for tagName, expected a string: ${a}.`);if(!(a in i))throw new Error(`Invalid block tag name: ${a}.`);l.tagName=a,r.addOperation({command:"setBlockTagName",id:l.id,tagName:a})},"set-property":function(t){const{attributes:e,children:o,state:r}=t,{id:n,...i}=e;if(Object.keys(i).length>0)throw new Error(`<set-property> has invalid attributes: ${Object.keys(i).join(", ")}`);if("string"!=typeof n)throw new Error("Block missing id attribute.");const a=r.blockIdMap[n];if(!a)throw new Error(`Block with id ${n} not found.`);if(!a.parent)throw new Error(`Block with id ${n} has no parent.`);if(0===o.length)throw new Error("No properties specified");if(o.length>1)throw new Error(`Attempted to set multiple properties: ${JSON.stringify(o)}.`);const s=m(o[0]),l=s.attributes.name;if("string"!=typeof l||!(l in a.properties))throw new Error("Attempted to add a new property to a block.");if(!a.parent)throw new Error("Attempted to set a property on a block without a parent.");a.properties[l]=s,r.addOperation({command:"setBlockProperty",blockId:a.id,parentBlockId:a.parent.id,property:s})},chat:function(t){const{attributes:e,children:o,state:r}=t;if(Object.keys(e).length>0)throw new Error(`<chat> has invalid attributes: ${Object.keys(e).join(", ")}`);const n=d({children:o,state:r,allowMove:!1}),i=n.map((t=>t.id)),a=[...n,...n.flatMap((t=>I(t)))].map((t=>({command:"createBlock",blockNode:t})));r.chat(i,a)},"persist-blocks":function(t){const{children:e,state:o}=t,r=d({children:e,state:o,allowMove:!1});for(const n of r)p({block:n,state:o})}};function d(t){const{children:e,state:o,allowMove:r}=t;return e.map((t=>u({node:t,persisted:!1,state:o,allowMove:r})))}function p(t){const{block:e,state:o}=t;if(!e.persisted){o.addOperation({command:"createBlock",blockNode:e});for(const t of e.children)p({block:t,state:o});e.persisted=!0}}function u(t){var e;const{node:o,persisted:r,state:n,allowMove:l}=t;if("element"!==o.type)throw new Error("Not an element.");const c=o.tagName;if("move"===o.tagName){var d;if(!l)throw new Error("<move> is not allowed in this context.");if(null===(d=o.attributes)||void 0===d||!d.id)throw new Error("Move is missing id attribute");const t=n.blockIdMap[o.attributes.id];if(!t)throw new Error(`Block not found: ${o.attributes.id}`);return t}if(!i[c])throw new Error(`Unsupported block tag name: ${c}.`);const p=null===(e=o.attributes)||void 0===e?void 0:e.id;let f;if(r){if(!p)throw new Error(`XML node is missing ID attribute: ${o.tagName}.`);f=p}else{if(p)throw new Error("When creating new blocks, do not provide an ID attribute.");f=n.randomID()}return n.blockIdMap[f]||function(t){let{id:e,tagName:o,attributes:r,childNodes:n,persisted:l,state:c,allowMove:d}=t;const p=i[o].title,f=i[o].properties,b=i[o].content,v=Object.fromEntries(Object.entries(i[o].attributes).map((t=>{let[e,{values:o}]=t;return[e,o]})));v.id=!0;for(const[i,a]of Object.entries(r)){const t=v[i];if(!t)throw new Error(`Attempted to set an attribute that is not allowed: ${i}.`);if(!0!==t&&!t.includes(a))throw new Error(`Attempted to set attribute ${i} to value that is not allowed: ${a}.`)}const w={...r,id:e},y={type:"block",id:e,tagName:o,persisted:l,attributes:w,text:[],properties:{},children:[],parent:void 0};for(const i of n)if("text"===i.type){if(i.value){const t=g({value:i.value});if(y.children.length>0)throw new Error(`Encountered a text node after a child block node: ${i.value}.`);if(Object.keys(y.properties).length>0)throw new Error(`Encountered a text node after a child property node: ${i.value}.`);if(!p)throw new Error(`Encountered a text node in a block that doesn't allow title: ${i.value}.`);y.text.push(t)}}else if("element"===i.type){const t=i.tagName;if(s[t]){if(y.children.length>0)throw new Error(`Encountered an inline node after a child block node: ${t} inside ${o}.`);if(Object.keys(y.properties).length>0)throw new Error(`Encountered an inline node after a child property node: ${t}.`);if(!p)throw new Error(`Encountered an inline node in a block that doesn't allow title: ${t} inside ${o}.`);const e=h(i);y.text.push(e)}else if(a[t]){if(y.children.length>0)throw new Error(`Encountered a property node after a child block node: ${t}.`);if(!0!==f&&!f.includes(t))throw new Error(`Encountered a property node in a block that doesn't allow it: ${t}.`);const e=m(i);y.properties[e.attributes.name]=e}else{if(!0!==b&&!b.includes(t))throw new Error(`Encountered a block node in a block that doesn't allow content: ${t} inside ${o}.`);const e=u({node:i,persisted:l,state:c,allowMove:d});e.parent=y,y.children.push(e)}}if(y.id in c.blockIdMap)throw new Error(`Attempted to create a duplicate block with id: ${y.id}`);return c.blockIdMap[y.id]=y,y}({tagName:c,id:f,attributes:o.attributes||{},childNodes:o.children||[],persisted:r,state:n,allowMove:l})}function m(t){var e;if("element"!==t.type)throw new Error("Not an element.");const o=t.tagName;if(!a[o])throw new Error(`Unsupported property tag name: ${o}.`);const r=null===(e=t.attributes)||void 0===e?void 0:e.name;if(!r)throw new Error(`Property node is missing name attribute: ${t.tagName}.`);return{type:"property",tagName:o,attributes:{name:r},children:f(t.children||[])}}function h(t){if("element"!==t.type)throw new Error("Not an element.");const e=t.tagName;if(s[e]){const o=t.attributes||{},r=Object.fromEntries(Object.entries(s[e].attributes).map((t=>{let[e,{values:o}]=t;return[e,o]})));for(const[t,e]of Object.entries(o)){const o=r[t];if(!o)throw new Error(`Attempted to set an attribute that is not allowed: ${t}.`);if(!0!==o&&!o.includes(e))throw new Error(`Attempted to set attribute ${t} to value that is not allowed: ${e}.`)}return{type:"inline",tagName:e,attributes:o,children:f(t.children||[])}}throw new Error(`Unsupported inline tag name: ${e}.`)}function f(t){const e=[];for(const o of t)if("text"===o.type){if(o.value){const t=g({value:o.value});e.push(t)}}else if("element"===o.type){const t=o.tagName;if(!s[t])throw new Error(`Encountered an unsupported inline tag name: ${t}.`);{const t=h(o);e.push(t)}}return e}const b="\x3c!--<selection>--\x3e",v="\x3c!--</selection>--\x3e";function w(t){const{node:e,state:o}=t,r=[];if("text"===e.type)for(const s of e.value)r.push(s);else{let t="";t+=`<${e.tagName}`;for(const[o,r]of Object.entries(e.attributes||{}))t+=` ${o}="${r}"`;t+=">";const c=`</${e.tagName}>`;if("block"===e.type){var n,i,a;const s="block"===e.type&&"block"===(null===(n=o.selection)||void 0===n?void 0:n.type)&&o.selection.blockIds.includes(e.id);s&&r.push(b),r.push(t);const l=[];if(e.text)for(const t of e.text){const e=w({node:t,state:o});for(const t of e)l.push(t)}let d,p;"text"===(null===(i=o.selection)||void 0===i?void 0:i.type)&&o.selection.start.blockId===e.id&&(d=o.selection.start.index),"text"===(null===(a=o.selection)||void 0===a?void 0:a.type)&&o.selection.end.blockId===e.id&&(p=o.selection.end.index);for(let t=0;t<l.length;t++){const e=l[t];let o="";t===d&&(o+=b),t===p&&(o+=v),o+=e,r.push(o)}d===l.length&&r.push(b),p===l.length&&r.push(v);for(const t of Object.values(e.properties))r.push(...w({node:t,state:o}));if(e.children)for(const t of e.children){const e=w({node:t,state:o});for(const t of e)r.push(t)}r.push(c),s&&r.push(v)}else{var l;const n=[];if(e.children)for(const t of e.children){const e=w({node:t,state:o});for(const t of e)n.push(t)}if(n.length<=1||null!==(l=s[e.tagName])&&void 0!==l&&l.isToken)r.push(t+n.join("")+c);else for(let e=0;e<n.length;e++){const o=n[e];0===e?r.push(t+o):e===n.length-1?r.push(o+c):r.push(o)}}}return r}function g(t){let{value:e}=t;return{type:"text",value:e}}function y(t){const{parent:e,index:o,insert:r,state:n}=t,a=Array.isArray(r)?r:[r],s=i[e.tagName].content,l=a.map((t=>t.tagName));for(const i of l)if(!0!==s&&!s.includes(i))throw new Error(`Encountered a block node in a block that doesn't allow content: ${i} inside ${e.tagName}.`);for(let i=a.length-1;i>=0;i--){const t=a[i];if("block"!==t.type)throw new Error("Cannot insert a non-block node.");t.parent=e,e.children.splice(o,0,t),p({block:t,state:n})}}function k(t){const{remove:e,state:o}=t;for(const r of e)if(r.parent){const t=r.parent.children.indexOf(r);if(t<0)throw new Error("Cannot remove block without parent.");o.addOperation({command:"removeBlock",parentId:r.parent.id,removeId:r.id}),r.parent.children.splice(t,1),r.parent=void 0}}function I(t){const e=[];for(const o of t.children)e.push(o),e.push(...I(o));return e}function E(t){const e={};for(const o in t)U({block:t[o],oldMap:t,newMap:e});return e}function U(t){const{block:e,oldMap:o,newMap:r}=t;if(r[e.id])return r[e.id];const i={type:"block",id:e.id,tagName:e.tagName,attributes:{...e.attributes},persisted:e.persisted,parent:void 0,children:[],text:n().cloneDeep(e.text),properties:n().cloneDeep(e.properties)};return r[e.id]=i,i.children=e.children.map((t=>U({block:t,oldMap:o,newMap:r}))),e.parent&&(i.parent=U({block:e.parent,oldMap:o,newMap:r})),e.parent,i}},88891:(t,e,o)=>{o.d(e,{N:()=>c});var r=o(41432),n=o(482),i=o(71644),a=o(21202),s=o(97880),l=o(24993);function c(t){let{assistantOperation:e,actorPointer:o,getRecordValue:c}=t;const p=Date.now(),u={last_edited_by_table:o.table,last_edited_by_id:o.id,last_edited_time:p},m={created_by_table:o.table,created_by_id:o.id,created_time:p,...u};if("createBlock"===e.command){var h,f;const t=l.BO[e.blockNode.tagName];if(!t)throw new Error(`Unknown block type: ${e.blockNode.tagName}`);const o={};if(e.blockNode.attributes)for(const[r,n]of Object.entries(e.blockNode.attributes))o[r]=(0,l.O2)(r,n);return[{pointer:{table:a.iU,id:d(e.blockNode.id)},command:"set",path:[],args:{type:t,properties:{title:e.blockNode.text.length>0?(0,l.Yt)(e.blockNode.text):void 0,...o},content:null===(h=e.blockNode.children)||void 0===h?void 0:h.map((t=>d(t.id))),...(null===(f=e.blockNode.parent)||void 0===f?void 0:f.id)&&{parent_id:d(e.blockNode.parent.id),parent_table:a.iU,alive:!0},...m}}]}if("removeBlock"===e.command)return[{pointer:{table:a.iU,id:d(e.parentId)},command:"listRemove",path:["content"],args:{id:d(e.removeId)}},n.op.update({pointer:{table:a.iU,id:d(e.parentId)},path:[],args:u}),{pointer:{table:a.iU,id:d(e.removeId)},command:"update",path:[],args:{parent_id:d(e.parentId),parent_table:a.iU,alive:!1,...u}}];if("insertBlockBefore"===e.command)return[{pointer:{table:a.iU,id:d(e.parentId)},command:"listBefore",path:["content"],args:{id:d(e.insertId),before:e.beforeId?d(e.beforeId):void 0}},n.op.update({pointer:{table:a.iU,id:d(e.parentId)},path:[],args:u}),{pointer:{table:a.iU,id:d(e.insertId)},command:"update",path:[],args:{parent_id:d(e.parentId),parent_table:a.iU,alive:!0,...u}}];if("insertBlockAfter"===e.command)return[{pointer:{table:a.iU,id:d(e.parentId)},command:"listAfter",path:["content"],args:{id:d(e.insertId),after:e.afterId?d(e.afterId):void 0}},n.op.update({pointer:{table:a.iU,id:d(e.parentId)},path:[],args:u}),{pointer:{table:a.iU,id:d(e.insertId)},command:"update",path:[],args:{parent_id:d(e.parentId),parent_table:a.iU,alive:!0,...u}}];if("setBlockText"===e.command)return[{pointer:{table:a.iU,id:d(e.id)},command:"update",path:["properties"],args:{title:e.text&&e.text.length>0?(0,l.Yt)(e.text):void 0}},n.op.update({pointer:{table:a.iU,id:d(e.id)},path:[],args:u})];if("setBlockAttribute"===e.command)return[{pointer:{table:a.iU,id:d(e.id)},command:"update",path:["properties"],args:{[e.attribute]:(0,l.O2)(e.attribute,e.value)}},n.op.update({pointer:{table:a.iU,id:d(e.id)},path:[],args:u})];if("setBlockTagName"===e.command){const t=l.BO[e.tagName];if(!t)throw new Error(`Unknown tag name: ${e.tagName}`);return[{pointer:{table:a.iU,id:d(e.id)},command:"update",path:[],args:{type:t,...u}}]}if("setBlockProperty"===e.command){var b;const{blockId:t,property:o,parentBlockId:s}=e,d=c({table:a.iU,id:t}),p=c({table:a.iU,id:s});if(!d)throw new Error(`Block not found: ${t}.`);if(!p)throw new Error(`Block not found: ${s}.`);if(d.type!==r.ZP.tableRow)throw new Error(`Cannot set property (${o.attributes.name}) on block type ${d.type}.`);if(p.type!==r.ZP.table)throw new Error("Parent block is not of type table.");const m=Number(o.attributes.name);if(!Number.isInteger(m)||m<0)throw new Error(`Invalid column index: ${m}.`);const h=(null===(b=p.format)||void 0===b?void 0:b.table_block_column_order)||[];if(m>h.length)throw new Error(`Column index too high: ${m}.`);const f=h[m];let v;f?v=f:(v=(0,i.Z)(),h.push((0,i.Z)()));const w=[n.op.set({pointer:{table:a.iU,id:t},path:["properties",v],args:o.children.length>0?(0,l.Yt)(o.children):void 0}),n.op.update({pointer:{table:a.iU,id:t},path:[],args:u})];return f||w.push(n.op.set({pointer:{table:a.iU,id:s},path:["format","table_block_column_order"],args:h}),n.op.update({pointer:{table:a.iU,id:s},path:[],args:u})),w}(0,s.t1)(e)}function d(t){return t.split("/")[0]}},24993:(t,e,o)=>{o.d(e,{P5:()=>S,IT:()=>x,O2:()=>B,Yt:()=>A,BO:()=>j});var r=o(96486),n=o.n(r),i=o(17215),a=o(41432),s=o(99036),l=o(16691),c=o(64572),d=o(97794),p=o(74446),u=o(45953),m=o(98459),h=o(98963),f=o(18844),b=o(21202),v=o(13493),w=o(70279),g=o(33709),y=o(80396),k=o(19889),I=o(70203),E=o(97880),U=o(7928),C=o(78395);function S(t){const e=(new DOMParser).parseFromString(`<wrap>${t}</wrap>`,"application/xml"),o=e.querySelector("parsererror");if(o)throw new Error(o.textContent||"Unknown error");return Array.from(e.childNodes[0].childNodes).map(N)}function N(t){if(t.nodeType===Node.ELEMENT_NODE){const e=t;return{type:"element",tagName:e.tagName.toLowerCase(),attributes:_(e.attributes),children:Array.from(t.childNodes).map(N)}}if(t.nodeType===Node.TEXT_NODE)return{type:"text",value:t.nodeValue||""};throw new Error(`Unexpected node type: ${t.nodeType}`)}function _(t){const e={};for(let o=0;o<t.length;o++){const r=t.item(o);r&&(e[r.name]=r.value)}return e}async function x(t){const{pointer:e,loadRecordValue:o,baseUrl:r,publicDomainName:s,intl:m}=t,{recordMap:E}=await async function(t){const{loadRecordValue:e}=t,o=t.pointer,r=u.Ak.create(),s=new Set,m=p.zF.fromMonomorphicFunctionUnsafe((async t=>{const o=r.get(t);if(o)return o;const n=await e(t);return r.set(t,n),n&&await E(t.table,n),n})),E=async function(e,o){const r=[],p=o;if(p.parent_table&&p.parent_id&&r.push([u.dr.getParentPointerFromRecordWithParent(p),"Block parent_id"]),e===b.iU){var E;const e=o;if(e.view_ids)for(const t of e.view_ids)r.push([{table:v.n,id:t,spaceId:e.space_id},"CollectionViewBlock view_id"]);const s=d.kk.fromBlock(e).getCollectionPointer();if(s&&r.push([s,"CollectionViewBlock collection_id"]),e.discussions)for(const t of e.discussions)r.push([u.dr.fromPointerLike({table:g.qF,id:t,spaceId:e.space_id}),"Discussion"]);if((0,i.XD)(e.type)&&e.properties&&e.properties.title){const o=I.lz(e.properties.title),i=n().union(...o.map(I.hD));for(const n of i){if(I.ST(n)&&r.push([{table:b.iU,id:I.TO(n)},"page annotation"]),I.IW(n)&&r.push([{table:k.KJ,id:I.zE(n)},"user annotation"]),I.j0(n)){const e=I.zW(n),o=(0,c.A5)({url:e,baseUrl:t.baseUrl,publicDomainName:t.publicDomainName});o&&r.push([{table:b.iU,id:o},"link annotation"])}if(I.nS(n)){const t=I.Ik(n);t&&r.push([{table:b.iU,id:t,spaceId:e.space_id},"eoi annotation"])}}}if(e.type===a.ZP.alias&&e.format&&e.format.alias_pointer&&r.push([e.format.alias_pointer,"alias"]),e.type===a.ZP.externalObjectInstance){var U,C;const t=(null===(U=e.format)||void 0===U?void 0:U.related_external_object_uris_to_instance_ids)&&Object.values(null===(C=e.format)||void 0===C?void 0:C.related_external_object_uris_to_instance_ids)||[];for(const o of t)r.push([{table:b.iU,id:o,spaceId:e.space_id},"eoi"])}e.type===a.ZP.button&&null!==(E=e.format)&&void 0!==E&&E.automation_id&&r.push([{table:h.cv,id:e.format.automation_id,spaceId:e.space_id},"button_automation"])}else if(e===g.qF){const t=o,e=t.comments||[];for(const o of e)r.push([u.dr.fromPointerLike({table:w.x_,id:o,spaceId:t.space_id}),"discussion table comment"])}else if(e===w.x_){const t=o,e=t.content;if(e)for(const o of e)r.push([u.dr.fromPointerLike({table:b.iU,id:o,spaceId:t.space_id}),"comment table comment"]);if(t.reactions)for(const o of t.reactions)r.push([u.dr.fromPointerLike({table:y.yo,id:o,spaceId:t.space_id}),"comment table reaction"])}else if(e===v.n){var S;const t=o,e=null==t||null===(S=t.format)||void 0===S?void 0:S.collection_pointer;e&&r.push([e,"CollectionView collection_id"])}else if(e===h.cv){const t=o;for(const e of t.action_ids??[])r.push([{table:f.Xj,id:e,spaceId:t.space_id},"Automation action_ids"])}await Promise.all(r.filter((t=>{let[e,o]=t;const r=(0,l.dn)(e);return!s.has(r)&&(s.add(r),!0)})).map((t=>{let[e,o]=t;return e})).map(m))};let U=[o];const C=async function(){if(0===U.length)return!1;const t=U;U=[];const e=await Promise.all(t.map((async t=>await m(t))));for(let r=0;r<t.length;r++){const t=e[r],n=t&&t.content;if(t&&n&&"column_list"===t.type)for(const e of n)U.push({table:b.iU,id:e});else if(t&&"transclusion_reference"===t.type&&t.format&&t.format.transclusion_reference_pointer)U.push(t.format.transclusion_reference_pointer);else if(t&&n&&(0,i.Um)(t.type,t.format)&&(t.id===o.id||"page"!==t.type&&!(0,i.BX)(t.type,t.format)))for(const e of n)U.push({table:b.iU,id:e})}return!0};for(;await C(););return{recordMap:r}}({pointer:e,baseUrl:r,publicDomainName:s,loadRecordValue:o}),U=M({pointer:e,recordMap:E,rootPointer:e,parentPointer:void 0,intl:m});if(!U)throw new Error("Failed to build XML node");return U}function O(t){const{intl:e,textValue:o,recordMap:r}=t,n=[];for(const a of o){let o=n,s=!1;const l=I.hD(a);for(const n of l){I.ZA(n)&&(s=!0);const a=I.J7(n),[l]=P[a];if(!C.t[l])continue;const c={type:"inline",tagName:l,attributes:{},children:[]};if(I.j0(n)){const t=I.zW(n);c.attributes.href=t}else if(I.ST(n)){const e=I.TO(n),o=r.get({table:b.iU,id:e});if(o){"collection_view"===o.type||"collection_view_page"===o.type?(c.tagName="mention-database",c.attributes["database-id"]=e):(c.tagName="mention-page",c.attributes["page-id"]=e);const r=(0,m.Bq)({table:b.iU,value:o});if(r){const e=t.recordMap.get(r);null!=e&&e.name&&(c.children=[{type:"text",value:I.Q(e.name)}])}else{var i;c.children=[{type:"text",value:I.Q(null===(i=o.properties)||void 0===i?void 0:i.title)}]}}}else if(I.IW(n)){const t=I.zE(n);c.attributes["person-id"]=t;const o=r.get({table:k.KJ,id:t});o&&(c.children=[{type:"text",value:(0,U.Nz)(e,o)}])}o.push(c),o=c.children}if(!s){const t=I.Wi(a);o.push({type:"text",value:t})}}return n}function M(t){const{pointer:e,recordMap:o,rootPointer:r,parentPointer:n,intl:i}=t,s=o.get(e);if(!s)return;const l=D[s.type];if(!C.pX[l])return;const c={type:"block",id:s.id,tagName:l,text:[],attributes:{id:s.id},properties:{},children:[],parent:void 0,persisted:!0};if(s.type===a.ZP.page)T({node:c,block:s,recordMap:o,intl:i}),e!==r&&(c.tagName="child-page",c.attributes.id=`${s.id}/${(null==n?void 0:n.id)||r.id}`,c.attributes["page-id"]=s.id);else if(s.type===a.ZP.collectionView||s.type===a.ZP.collectionViewPage)T({node:c,block:s,recordMap:o,intl:i}),e!==r&&(c.tagName="child-database",c.attributes.id=`${s.id}/${(null==n?void 0:n.id)||r.id}`,c.attributes["database-id"]=s.id);else if(s.type===a.ZP.alias){var d;if(null===(d=s.format)||void 0===d||!d.alias_pointer||s.format.alias_pointer.table!==b.iU)return;const t=o.get(s.format.alias_pointer);if(!t)return;T({node:c,block:t,recordMap:o,intl:i}),t.type===a.ZP.collectionView||t.type===a.ZP.collectionViewPage?(c.tagName="link-database",c.attributes["database-id"]=t.id):(c.tagName="link-page",c.attributes["page-id"]=t.id)}else if(s.type===a.ZP.table){var p,u;const t=null===(p=s.format)||void 0===p?void 0:p.table_block_row_header,e=null===(u=s.format)||void 0===u?void 0:u.table_block_column_header;t&&(c.attributes["header-row"]=t?"true":"false"),e&&(c.attributes["header-column"]=e?"true":"false")}else if(s.type===a.ZP.tableRow){var m;if(s.parent_table!==b.iU)return;const t=o.get({table:s.parent_table,id:s.parent_id,spaceId:s.space_id});if(!t||t.type!==a.ZP.table)return;const e=(null===(m=t.format)||void 0===m?void 0:m.table_block_column_order)||[];for(const r of e){var h;const t=e.indexOf(r).toString(),n={type:"property",tagName:"property-text",attributes:{name:t},children:O({textValue:(null===(h=s.properties)||void 0===h?void 0:h[r])||[],recordMap:o,intl:i})};c.properties[t]=n}}else T({block:s,node:c,recordMap:o,intl:i});if(s.content){const t=s.content.map((t=>M({pointer:{table:"block",id:t},recordMap:o,rootPointer:r,parentPointer:e,intl:i}))).filter(E.$K);c.children.push(...t)}return c}function T(t){const{block:e,node:o,recordMap:r,intl:n}=t;for(const a of s.qF){var i;const s=null===(i=e.properties)||void 0===i?void 0:i[a];if("title"===a){const i=(0,m.Bq)({table:b.iU,value:e});if(i){const e=t.recordMap.get(i);null!=e&&e.name&&o.text.push(...O({textValue:e.name,recordMap:r,intl:n}))}else s&&o.text.push(...O({textValue:s,recordMap:r,intl:n}))}else if(s){const t=$(a,s);t&&(o.attributes[a]=t)}}}function $(t,e){if("checked"===t)return I.Q(e)===s.bx?"true":"false"}function B(t,e){if("checked"===t)return"true"===e?I.TP(s.bx):void 0}function A(t){const e=t.flatMap((t=>{if("inline"===t.type){const e=Z[t.tagName];if(!e)throw new Error(`Unknown inline element: ${t.tagName}`);const o=t.attributes,r=A(t.children),n=[e,...P[e].slice(1).map((e=>{const r=o[e];if(!r)throw new Error(`Missing attribute ${e} for inline element ${t.tagName}`);return r}))];return r.map((t=>I.V3(I.Wi(t),[n,...I.hD(t)])))}if("text"===t.type)return[I.V3(t.value,[])];(0,E.t1)(t)}));return I.Zx(e)}const D={text:"text",page:"page",bulleted_list:"uli",numbered_list:"oli",toggle:"toggle",quote:"quote",factory:"factory",button:"button",to_do:"todo",column_list:"columns",column:"column",embed:"embed",framer:"embed",tweet:"embed",gist:"embed",drive:"embed",figma:"embed",loom:"embed",typeform:"embed",codepen:"embed",audio:"embed",maps:"embed",invision:"embed",image:"embed",pdf:"embed",video:"embed",file:"embed",bookmark:"embed",equation:"math-block",code:"code-block",header:"h1",sub_header:"h2",sub_sub_header:"h3",collection_view:"database",collection_view_page:"database",breadcrumb:"breadcrumb",copy_indicator:"copy_indicator",link_to_page:"link_to_page",link_to_collection:"link_to_collection",alias:"link-page",transclusion_container:"syncedblocksource",transclusion_reference:"syncedblockreference",divider:"hr",callout:"callout",table_of_contents:"tableofcontents",whimsical:"embed",miro:"embed",abstract:"embed",sketch:"embed",excalidraw:"embed",replit:"embed",hex:"embed",deepnote:"embed",external_object_instance:"embed",external_object_instance_page:"embed",table:"table",table_row:"tr",tab:"tab",ai_block:"ai-block"},j={...Object.fromEntries((0,E.qP)(D).map((t=>{let[e,o]=t;return[o,e]}))),"child-page":"page","child-database":"page","link-page":"alias","link-database":"alias"},P={b:["b"],i:["i"],s:["s"],c:["code"],_:["u"],"+":["+"],"-":["-"],z:["z"],u:["person"],r:["r"],p:["mention-page"],pt:["pt"],d:["date"],eoi:["eoi"],tv:["tv"],cm:["cm"],m:["m"],a:["a","href"],h:["h"],e:["e"],et:["et"],xt:["xt"],st:["st"],fpp:["fpp"],fup:["fup"],fv:["fv"],g:["group"]},Z=Object.fromEntries((0,E.qP)(P).map((t=>{let[e,[o]]=t;return[o,e]})))}}]);