"use strict";(self.webpackChunknotion_next=self.webpackChunknotion_next||[]).push([[9447],{32319:(e,t,n)=>{n.r(t),n.d(t,{addTypesToFormulaAST:()=>He,analyzeFormula:()=>yt,convertFormulaCSTToAST:()=>ke,evaluateFormulaAST:()=>Ke,executeFormula:()=>lt,getFormulaEditorInfoAtPosition:()=>at,getMessageForFormulaEvaluatorError:()=>ut,getMessageForFormulaTypecheckError:()=>pt,getNodeOfInterestForFormulaTypecheckError:()=>st,parseFormulaInput:()=>ve,processFormulaInput:()=>ze});var r=n(68626),o=n(7406),a=n(77090),i=n(6287);let s,p,u,l,y;!function(e){e.Number="number",e.String="string",e.Boolean="boolean",e.Array="array",e.Identifier="identifier",e.NotionToken="notionToken",e.Conditional="conditional",e.LogicalOr="logicalOr",e.LogicalAnd="logicalAnd",e.Equality="equality",e.Relational="relational",e.Additive="additive",e.Multiplicative="multiplicative",e.Exponentiation="exponentiation",e.Unary="unary",e.Call="call",e.UnifiedFunctionProperty="unifiedFunctionProperty",e.MemberBlockProperty="memberProperty",e.MemberUserProperty="memberUserProperty",e.RecoveryNode="recovery"}(s||(s={})),function(e){e[e.InvalidCharacter=0]="InvalidCharacter",e[e.UnclosedStringLiteral=1]="UnclosedStringLiteral",e[e.UnclosedComment=2]="UnclosedComment",e[e.TokenExpected=3]="TokenExpected",e[e.StringLiteralContainsToken=4]="StringLiteralContainsToken",e[e.ExpressionExpected=5]="ExpressionExpected",e[e.PropertyTokenOrFunctionExpected=6]="PropertyTokenOrFunctionExpected",e[e.EndOfInputExpected=7]="EndOfInputExpected",e[e.UnexpectedError=8]="UnexpectedError"}(p||(p={})),function(e){e[e.DateInvalidDurationUnit=0]="DateInvalidDurationUnit",e[e.TryingToGetIdWithoutThisRow=1]="TryingToGetIdWithoutThisRow",e[e.LetBindingNameNotIdentifier=2]="LetBindingNameNotIdentifier"}(u||(u={}));class c extends Error{constructor(e){super(),this.info=void 0,this.info=e}}!function(e){e[e.MissingThisRow=0]="MissingThisRow",e[e.MissingSchemaPropertyOnThisRow=1]="MissingSchemaPropertyOnThisRow",e[e.ThisRowBlockPropertyMismatchCollection=2]="ThisRowBlockPropertyMismatchCollection",e[e.MissingContextVariable=3]="MissingContextVariable",e[e.NonMemberUserProperty=4]="NonMemberUserProperty",e[e.IdentifierNotFound=5]="IdentifierNotFound",e[e.CannotRelativelyCompareTypes=6]="CannotRelativelyCompareTypes",e[e.CannotDoMathOnType=7]="CannotDoMathOnType",e[e.CannotCallNonFunction=8]="CannotCallNonFunction",e[e.UnifiedFunctionPropertyNotFound=9]="UnifiedFunctionPropertyNotFound",e[e.LibraryFunctionExecutionError=10]="LibraryFunctionExecutionError",e[e.FunctionCallTooFewArguments=11]="FunctionCallTooFewArguments",e[e.FunctionCallUnexpectedArgument=12]="FunctionCallUnexpectedArgument",e[e.FunctionCallArgumentWrongType=13]="FunctionCallArgumentWrongType",e[e.AccessingPropertyOnNonBlock=14]="AccessingPropertyOnNonBlock",e[e.AccessingUserPropertyOnNonPerson=15]="AccessingUserPropertyOnNonPerson",e[e.MissingDataDependencyBlock=16]="MissingDataDependencyBlock",e[e.MissingDataDependencyPerson=17]="MissingDataDependencyPerson",e[e.MemberPropertyMismatchCollection=18]="MemberPropertyMismatchCollection",e[e.MissingPropertyOnSchemaForMemberProperty=19]="MissingPropertyOnSchemaForMemberProperty",e[e.UnaryMinusOnNonNumber=20]="UnaryMinusOnNonNumber",e[e.UnexpectedRecoveryNode=21]="UnexpectedRecoveryNode",e[e.UnexpectedError=22]="UnexpectedError"}(l||(l={}));class d extends Error{constructor(e){super(),this.info=void 0,this.info=e}}!function(e){e[e.ThisRowTypeNotFound=0]="ThisRowTypeNotFound",e[e.ThisRowNotBlockWithCollection=1]="ThisRowNotBlockWithCollection",e[e.MissingPropertyOnThisRow=2]="MissingPropertyOnThisRow",e[e.MissingContextVariable=3]="MissingContextVariable",e[e.MissingBlockValue=4]="MissingBlockValue",e[e.NonMemberUserProperty=5]="NonMemberUserProperty",e[e.CallingNotFunction=6]="CallingNotFunction",e[e.FunctionCallTooFewArguments=7]="FunctionCallTooFewArguments",e[e.FunctionCallUnexpectedArgument=8]="FunctionCallUnexpectedArgument",e[e.FunctionCallArgumentWrongType=9]="FunctionCallArgumentWrongType",e[e.MemberPropertyMismatchCollection=10]="MemberPropertyMismatchCollection",e[e.MemberPropertyMissing=11]="MemberPropertyMissing",e[e.MemberPropertyTargetNotBlock=12]="MemberPropertyTargetNotBlock",e[e.MemberPropertyButtonType=13]="MemberPropertyButtonType",e[e.MemberUserPropertyTargetNotPerson=14]="MemberUserPropertyTargetNotPerson",e[e.UndefinedIdentifier=15]="UndefinedIdentifier",e[e.UnifiedFunctionCannotFindFunction=16]="UnifiedFunctionCannotFindFunction",e[e.UnifiedFunctionNoArguments=17]="UnifiedFunctionNoArguments",e[e.UnifiedFunctionTargetWrongType=18]="UnifiedFunctionTargetWrongType",e[e.CannotRelativelyCompareTypes=19]="CannotRelativelyCompareTypes",e[e.CannotDoMathOnType=20]="CannotDoMathOnType",e[e.UnaryMinusOnNonNumber=21]="UnaryMinusOnNonNumber"}(y||(y={}));var f=n(61326);const m=(0,a.V3)({name:"AdditionOperator",pattern:a.hW.NA}),h=(0,a.V3)({name:"UnaryOperator",pattern:a.hW.NA}),v=(0,a.V3)({name:"Plus",pattern:/\+/,categories:m}),x=(0,a.V3)({name:"Minus",pattern:/-/,categories:[m,h]}),g=(0,a.V3)({name:"ExclamationPoint",pattern:/!/,categories:h}),b=(0,a.V3)({name:"MultiplicationOperator",pattern:a.hW.NA}),k=(0,a.V3)({name:"Multi",pattern:/\*/,categories:b}),T=(0,a.V3)({name:"Div",pattern:/\//,categories:b}),O=(0,a.V3)({name:"Modulo",pattern:/%/,categories:b}),E=(0,a.V3)({name:"Caret",pattern:/\^/}),w=(0,a.V3)({name:"BooleanLiteral",pattern:a.hW.NA}),C=(0,a.V3)({name:"True",pattern:/true/i,categories:w}),U=(0,a.V3)({name:"False",pattern:/false/i,categories:w}),P=(0,a.V3)({name:"And",pattern:/and|&&/i}),M=(0,a.V3)({name:"Or",pattern:/or|\|\|/i}),N=(0,a.V3)({name:"Not",pattern:/not/i,categories:h}),L=(0,a.V3)({name:"RelationalOperator",pattern:a.hW.NA}),F=(0,a.V3)({name:"LessThan",pattern:/<=?/,categories:L}),A=(0,a.V3)({name:"GreaterThan",pattern:/>=?/,categories:L}),B=(0,a.V3)({name:"EqualityOperator",pattern:a.hW.NA}),S=(0,a.V3)({name:"Equal",pattern:/=/,categories:B}),R=(0,a.V3)({name:"NotEqual",pattern:/!=/,categories:B}),I=(0,a.V3)({name:"LParen",pattern:/\(/}),$=(0,a.V3)({name:"RParen",pattern:/\)/}),V=(0,a.V3)({name:"LBracket",pattern:/\[/}),D=(0,a.V3)({name:"RBracket",pattern:/\]/}),W=(0,a.V3)({name:"Comma",pattern:/,/}),_=(0,a.V3)({name:"Dot",pattern:/\./}),q=(0,a.V3)({name:"QuestionMark",pattern:/\?/}),j=(0,a.V3)({name:"Colon",pattern:/:/}),Z=(0,a.V3)({name:"StringLiteral",pattern:/"(?:[^\\"]|\\.)*"/,start_chars_hint:['"']}),J=(0,a.V3)({name:"UnclosedStringLiteral",pattern:/"(?:[^\\"]|\\.)*/,start_chars_hint:['"']}),X=(0,a.V3)({name:"NumberLiteral",pattern:/(0|[1-9]\d*)(\.\d+)?([eE][+-]?\d+)?/}),Y=(0,a.V3)({name:"Comment",pattern:/\/\*(?:[^*]|\*(?:[^\/]))*\*\//,group:a.hW.SKIPPED,start_chars_hint:["/*"]}),K=(0,a.V3)({name:"UnclosedComment",pattern:/\/\*(?:[^*]|\*(?:[^\/]))*/,group:a.hW.SKIPPED,start_chars_hint:["/*"]}),Q="[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}",z=f.Eb.replace(/\{/g,"\\{"),G=f.Av.replace(/\}/g,"\\}"),H=new RegExp(`${z}.*${G}`),ee=new RegExp(`^${z}${f.Oy.Block}:(${Q})(:${Q})?${G}`),te=new RegExp(`^${z}${f.Oy.Person}:(${Q})${G}`),ne=new RegExp(`^${z}${f.Oy.BlockProperty}:([^:]+)(:(${Q}):(${Q}))?${G}`),re=new RegExp(`^${z}${f.Oy.UserProperty}:(${Object.values(f.V2).join("|")})${G}`),oe=new RegExp(`^${z}${f.Oy.Checkbox}:(true|false)${G}`),ae=new RegExp(`^${z}${f.Oy.ContextValue}:([^}]+)${G}`),ie=new RegExp(`^${z}${f.Oy.Date}:([^}]+)${G}`),se=(0,a.V3)({name:"InputToken",pattern:{exec:(e,t)=>{if(!e.startsWith(f.Eb,t))return null;const n=e.substring(t),r=ne.exec(n);if(null!==r){const e=[r[0]],t=r[1];let n;if(void 0!==r[2])n={type:f.Oy.BlockProperty,property:t,collection:{table:i.v,id:r[3],spaceId:r[4]}};else{if(!f.WG.includes(t))return null;n={type:f.Oy.BlockProperty,property:t,collection:void 0}}return e.payload=n,e}const o=ee.exec(n);if(null!==o){const e=[o[0]],t={type:f.Oy.Block,blockId:o[1],spaceId:void 0!==o[2]?o[2].substring(1):void 0};return e.payload=t,e}const a=te.exec(n);if(null!==a){const e=[a[0]],t={type:f.Oy.Person,userId:a[1]};return e.payload=t,e}const s=re.exec(n);if(null!==s){const e=[s[0]],t={type:f.Oy.UserProperty,userProperty:s[1]};return e.payload=t,e}const p=oe.exec(n);if(null!==p){const e=[p[0]],t={type:f.Oy.Checkbox,checked:"true"===p[1]};return e.payload=t,e}const u=ae.exec(n);if(null!==u){const e=[u[0]],t=(0,f.wf)(u[1]),n={type:f.Oy.ContextValue,valueId:t};return e.payload=n,e}const l=ie.exec(n);if(null!==l){const e=[l[0]],t={type:f.Oy.Date,date:(0,f.DF)(l[1])};return e.payload=t,e}return null}},line_breaks:!1,start_chars_hint:[f.Eb]}),pe=(0,a.V3)({name:"IdentifierName",pattern:/([A-Za-z_][A-Za-z0-9_]*)/}),ue={WhiteSpace:(0,a.V3)({name:"WhiteSpace",pattern:/\s+/,group:a.hW.SKIPPED}),NumberLiteral:X,StringLiteral:Z,UnclosedStringLiteral:J,Comment:Y,UnclosedComment:K,InputToken:se,True:C,False:U,And:P,Or:M,Not:N,IdentifierName:pe,Equal:S,NotEqual:R,Plus:v,Minus:x,ExclamationPoint:g,Multi:k,Div:T,Modulo:O,Caret:E,LParen:I,RParen:$,LBracket:V,RBracket:D,AdditionOperator:m,MultiplicationOperator:b,LessThan:F,GreaterThan:A,QuestionMark:q,Colon:j,Comma:W,Dot:_},le=Object.values(ue),ye=new a.hW(Object.values(le));class ce extends a.wd{constructor(){super(le,{recoveryEnabled:!0,nodeLocationTracking:"onlyOffset"}),this.expression=this.RULE("expression",(()=>{this.SUBRULE(this.conditionalExpression)})),this.primaryExpression=this.RULE("primaryExpression",(()=>this.OR([{ALT:()=>this.SUBRULE(this.parenthesisExpression)},{ALT:()=>this.SUBRULE(this.arrayExpression)},{ALT:()=>this.CONSUME(X)},{ALT:()=>this.CONSUME(Z)},{ALT:()=>this.CONSUME(J)},{ALT:()=>this.CONSUME(w)},{ALT:()=>this.CONSUME(pe)},{ALT:()=>this.CONSUME(se)}]))),this.conditionalExpression=this.RULE("conditionalExpression",(()=>{this.SUBRULE(this.logicalOrExpression,{LABEL:"condition"}),this.OPTION((()=>{this.CONSUME(q),this.SUBRULE2(this.logicalOrExpression,{LABEL:"expIfTrue"}),this.CONSUME(j),this.SUBRULE3(this.logicalOrExpression,{LABEL:"expIfFalse"})}))})),this.logicalOrExpression=this.RULE("logicalOrExpression",(()=>{this.SUBRULE(this.logicalAndExpression,{LABEL:"lhs"}),this.OPTION((()=>{this.CONSUME(M),this.SUBRULE2(this.logicalAndExpression,{LABEL:"rhs"})}))})),this.logicalAndExpression=this.RULE("logicalAndExpression",(()=>{this.SUBRULE(this.equalityExpression,{LABEL:"lhs"}),this.OPTION((()=>{this.CONSUME(P),this.SUBRULE2(this.equalityExpression,{LABEL:"rhs"})}))})),this.equalityExpression=this.RULE("equalityExpression",(()=>{this.SUBRULE(this.relationalExpression,{LABEL:"lhs"}),this.OPTION((()=>{this.CONSUME(B),this.SUBRULE2(this.relationalExpression,{LABEL:"rhs"})}))})),this.relationalExpression=this.RULE("relationalExpression",(()=>{this.SUBRULE(this.additionExpression,{LABEL:"lhs"}),this.OPTION((()=>{this.CONSUME(L),this.SUBRULE2(this.additionExpression,{LABEL:"rhs"})}))})),this.additionExpression=this.RULE("additionExpression",(()=>{this.SUBRULE(this.multiplicationExpression,{LABEL:"lhs"}),this.MANY((()=>{this.CONSUME(m),this.SUBRULE2(this.multiplicationExpression,{LABEL:"rhs"})}))})),this.multiplicationExpression=this.RULE("multiplicationExpression",(()=>{this.SUBRULE(this.exponentiationExpression,{LABEL:"lhs"}),this.MANY((()=>{this.CONSUME(b),this.SUBRULE2(this.exponentiationExpression,{LABEL:"rhs"})}))})),this.exponentiationExpression=this.RULE("exponentiationExpression",(()=>{this.SUBRULE(this.unaryExpression,{LABEL:"lhs"}),this.MANY((()=>{this.CONSUME(E),this.SUBRULE2(this.unaryExpression,{LABEL:"rhs"})}))})),this.unaryExpression=this.RULE("unaryExpression",(()=>{this.OPTION((()=>{this.CONSUME(h)})),this.SUBRULE(this.memberCallExpression)})),this.memberCallExpression=this.RULE("memberCallExpression",(()=>{this.SUBRULE(this.primaryExpression),this.MANY((()=>{this.SUBRULE2(this.memberCallSubExpression)}))})),this.memberCallSubExpression=this.RULE("memberCallSubExpression",(()=>{this.OR([{ALT:()=>this.SUBRULE(this.dotMemberExpression)},{ALT:()=>this.SUBRULE(this.callArguments)}])})),this.dotMemberExpression=this.RULE("dotMemberExpression",(()=>{this.CONSUME(_),this.OR([{ALT:()=>this.CONSUME(pe)},{GATE:()=>{var e,t;const n=this.LA(1);return n.tokenType===se&&((null===(e=n.payload)||void 0===e?void 0:e.type)===f.Oy.BlockProperty||(null===(t=n.payload)||void 0===t?void 0:t.type)===f.Oy.UserProperty)},ALT:()=>this.CONSUME(se)}])})),this.callArguments=this.RULE("callArguments",(()=>{this.CONSUME(I),this.OPTION((()=>{this.SUBRULE(this.expression),this.MANY((()=>{this.CONSUME(W),this.SUBRULE2(this.expression)}))})),this.CONSUME($)})),this.parenthesisExpression=this.RULE("parenthesisExpression",(()=>{this.CONSUME(I),this.SUBRULE(this.expression),this.CONSUME($)})),this.arrayExpression=this.RULE("arrayExpression",(()=>{this.CONSUME(V),this.OPTION((()=>{this.SUBRULE(this.expression),this.MANY((()=>{this.CONSUME(W),this.SUBRULE2(this.expression)}))})),this.CONSUME(D)})),this.performSelfAnalysis()}}const de=new ce;function fe(e){const t=/unexpected character: ->(.+)<- at offset/.exec(e.message);if(null!==t)return{type:p.InvalidCharacter,character:t[1],offset:e.offset};if("unclosed string literal"===e.message)return{type:p.UnclosedStringLiteral,offset:e.offset};if("unclosed comment"===e.message)return{type:p.UnclosedComment,offset:e.offset};throw new Error(`Unhandled chevrotain recognition error: ${e.message}`)}const me={RParen:")",RBracket:"]"};function he(e){const t=e.token.tokenType===a.sd?"eof":e.token.startOffset;switch(e.name){case"MismatchedTokenException":{const n=/Expecting token of type --> (.+) <-- but found/.exec(e.message);if(null!==n){const e=n[1],r=me[e];if(void 0!==r)return{type:p.TokenExpected,token:r,offset:t}}break}case"NoViableAltException":{const n=e.context.ruleStack[e.context.ruleStack.length-1];switch(n){case"primaryExpression":return{type:p.ExpressionExpected,offset:t};case"dotMemberExpression":return{type:p.PropertyTokenOrFunctionExpected,offset:t}}throw new Error(`Unhandled unviable alt: ${n}`)}case"NotAllInputParsedException":return{type:p.EndOfInputExpected,offset:t}}throw new Error(`Unhandled chevrotain recognition error: ${e.name}`)}function ve(e){const t=ye.tokenize(e),n=[...t.errors],r=[];for(const a of n)r.push(fe(a));for(const a of t.tokens.filter((e=>e.tokenType===J||e.tokenType===K)))r.push({type:a.tokenType===J?p.UnclosedStringLiteral:p.UnclosedComment,offset:a.startOffset});for(const a of t.tokens.filter((e=>e.tokenType===Z)))H.test(a.image)&&r.push({type:p.StringLiteralContainsToken,offset:a.startOffset});de.input=t.tokens;const o=de.expression();for(const a of de.errors)r.push(he(a));return[o,r]}function xe(e){return e.find((e=>void 0!==e&&!isNaN(e)))}const ge=de.getBaseCstVisitorConstructor();const be=new class extends ge{constructor(){super(),this.validateVisitor()}expression(e){return this.visit(e.conditionalExpression)}primaryExpression(e){return void 0!==e.parenthesisExpression?this.visit(e.parenthesisExpression):void 0!==e.arrayExpression?this.visit(e.arrayExpression):void 0!==e.NumberLiteral?{kind:s.Number,text:e.NumberLiteral[0].image,startOffset:e.NumberLiteral[0].startOffset,endOffset:e.NumberLiteral[0].endOffset}:void 0!==e.StringLiteral?{kind:s.String,text:e.StringLiteral[0].image.substring(1,e.StringLiteral[0].image.length-1),startOffset:e.StringLiteral[0].startOffset,endOffset:e.StringLiteral[0].endOffset}:void 0!==e.UnclosedStringLiteral?{kind:s.String,text:e.UnclosedStringLiteral[0].image.substring(1,e.UnclosedStringLiteral[0].image.length),startOffset:e.UnclosedStringLiteral[0].startOffset,endOffset:e.UnclosedStringLiteral[0].endOffset}:void 0!==e.BooleanLiteral?{kind:s.Boolean,text:e.BooleanLiteral[0].image,startOffset:e.BooleanLiteral[0].startOffset,endOffset:e.BooleanLiteral[0].endOffset}:void 0!==e.InputToken?{kind:s.NotionToken,token:e.InputToken[0].payload,startOffset:e.InputToken[0].startOffset,endOffset:e.InputToken[0].endOffset}:void 0!==e.IdentifierName?{kind:s.Identifier,text:e.IdentifierName[0].image,startOffset:e.IdentifierName[0].startOffset,endOffset:e.IdentifierName[0].endOffset}:{kind:s.RecoveryNode,startOffset:-1,endOffset:-1}}conditionalExpression(e){const t=this.visit(e.condition[0]);var n,r,o,a,i,p;return void 0!==e.QuestionMark?{kind:s.Conditional,condition:t,expIfTrue:this.visit(e.expIfTrue[0]),expIfFalse:void 0!==(null===(n=e.expIfFalse)||void 0===n?void 0:n[0])?this.visit(e.expIfFalse[0]):void 0,startOffset:e.condition[0].location.startOffset,endOffset:xe([null===(r=e.expIfFalse)||void 0===r||null===(o=r[0].location)||void 0===o?void 0:o.endOffset,null===(a=e.Colon)||void 0===a||null===(i=a[0])||void 0===i?void 0:i.endOffset,null===(p=e.expIfTrue[0].location)||void 0===p?void 0:p.endOffset,e.QuestionMark[0].endOffset])}:t}logicalOrExpression(e){const t=this.visit(e.lhs[0]);if(void 0!==e.Or){var n;const r=e.rhs[0];return{kind:s.LogicalOr,lhs:t,rhs:this.visit(r),startOffset:e.lhs[0].location.startOffset,endOffset:xe([null===(n=r.location)||void 0===n?void 0:n.endOffset,e.Or[0].endOffset])}}return t}logicalAndExpression(e){const t=this.visit(e.lhs[0]);if(void 0!==e.And){var n;const r=e.rhs[0];return{kind:s.LogicalAnd,lhs:t,rhs:this.visit(r),startOffset:e.lhs[0].location.startOffset,endOffset:xe([null===(n=r.location)||void 0===n?void 0:n.endOffset,e.And[0].endOffset])}}return t}equalityExpression(e){const t=this.visit(e.lhs[0]);if(void 0!==e.EqualityOperator){var n;const r=e.rhs[0];return{kind:s.Equality,op:e.EqualityOperator[0].image,lhs:t,rhs:this.visit(r),startOffset:e.lhs[0].location.startOffset,endOffset:xe([null===(n=r.location)||void 0===n?void 0:n.endOffset,e.EqualityOperator[0].endOffset])}}return t}relationalExpression(e){const t=this.visit(e.lhs[0]);if(void 0!==e.RelationalOperator){var n;const r=e.rhs[0];return{kind:s.Relational,op:e.RelationalOperator[0].image,lhs:t,rhs:this.visit(r),startOffset:e.lhs[0].location.startOffset,endOffset:xe([null===(n=r.location)||void 0===n?void 0:n.endOffset,e.RelationalOperator[0].endOffset])}}return t}additionExpression(e){let t=this.visit(e.lhs[0]);if(void 0!==e.AdditionOperator)for(let r=0;r<e.AdditionOperator.length;r++){var n;const o=e.rhs[r];t={kind:s.Additive,op:e.AdditionOperator[r].image,lhs:t,rhs:this.visit(o),startOffset:e.lhs[0].location.startOffset,endOffset:xe([null===(n=o.location)||void 0===n?void 0:n.endOffset,e.AdditionOperator[r].endOffset])}}return t}multiplicationExpression(e){let t=this.visit(e.lhs[0]);if(void 0!==e.MultiplicationOperator)for(let r=0;r<e.MultiplicationOperator.length;r++){var n;const o=e.rhs[r];t={kind:s.Multiplicative,op:e.MultiplicationOperator[r].image,lhs:t,rhs:this.visit(o),startOffset:e.lhs[0].location.startOffset,endOffset:xe([null===(n=o.location)||void 0===n?void 0:n.endOffset,e.MultiplicationOperator[r].endOffset])}}return t}exponentiationExpression(e){let t;const n=this.visit(e.lhs[0]);if(void 0!==e.Caret){var r;const o=e.Caret.length-1;let a,i=null===(r=e.rhs[o].location)||void 0===r?void 0:r.endOffset;(void 0===i||isNaN(i))&&(i=e.Caret[o].endOffset);for(let n=e.Caret.length-1;n>=0;n--){const r=e.rhs[n];t=void 0===a?this.visit(r):{kind:s.Exponentiation,op:a,lhs:this.visit(r),rhs:t,startOffset:r.location.startOffset,endOffset:i},a=e.Caret[n].image}return{kind:s.Exponentiation,op:a,lhs:n,rhs:t,startOffset:e.lhs[0].location.startOffset,endOffset:i}}return n}unaryExpression(e){const t=this.visit(e.memberCallExpression[0]);return void 0!==e.UnaryOperator?{kind:s.Unary,op:e.UnaryOperator[0].image.toLowerCase(),expression:t,startOffset:e.UnaryOperator[0].startOffset,endOffset:t.endOffset}:t}memberCallExpression(e){let t=this.visit(e.primaryExpression[0]),n=e.primaryExpression[0].location.startOffset;var r;isNaN(n)&&(n=null===(r=e.memberCallSubExpression)||void 0===r?void 0:r[0].location.startOffset);if(void 0!==e.memberCallSubExpression)for(const u of e.memberCallSubExpression){const e=u.location.endOffset;if(void 0!==u.children.callArguments){var o,a,i,p;const r=u.children.callArguments[0].children;t={kind:s.Call,expression:t,arguments:(null===(o=u.children.callArguments[0])||void 0===o||null===(a=o.children.expression)||void 0===a?void 0:a.map((e=>this.visit(e))))??[],lParenOffset:r.LParen[0].startOffset,rParenOffset:null===(i=r.RParen)||void 0===i?void 0:i[0].startOffset,commaOffsets:(null===(p=r.Comma)||void 0===p?void 0:p.map((e=>e.startOffset)))??[],startOffset:n,endOffset:e}}else if(void 0!==u.children.dotMemberExpression){const r=u.children.dotMemberExpression[0].children;if(void 0!==r.IdentifierName){const o=r.IdentifierName[0];t={kind:s.UnifiedFunctionProperty,expression:t,name:o.image,nameStartOffset:o.startOffset,nameEndOffset:o.endOffset,startOffset:n,endOffset:e}}else if(void 0!==r.InputToken){const o=r.InputToken[0],a=o.payload;switch(a.type){case f.Oy.BlockProperty:t={kind:s.MemberBlockProperty,expression:t,propertyToken:void 0===a.collection?{property:a.property,collection:void 0}:{property:a.property,collection:a.collection},propertyStartOffset:o.startOffset,propertyEndOffset:o.endOffset,startOffset:n,endOffset:e};break;case f.Oy.UserProperty:t={kind:s.MemberUserProperty,expression:t,userProperty:a.userProperty,propertyStartOffset:o.startOffset,propertyEndOffset:o.endOffset,startOffset:n,endOffset:e}}}}}return t}parenthesisExpression(e){return this.visit(e.expression[0])}arrayExpression(e){var t,n,r,o,a,i,p;return{kind:s.Array,elements:(null===(t=e.expression)||void 0===t?void 0:t.map((e=>this.visit(e))))??[],lBracketOffset:e.LBracket[0].startOffset,rBracketOffset:null===(n=e.RBracket)||void 0===n?void 0:n[0].startOffset,commaOffsets:(null===(r=e.Comma)||void 0===r?void 0:r.map((e=>e.startOffset)))??[],startOffset:e.LBracket[0].startOffset,endOffset:xe([null===(o=e.RBracket)||void 0===o?void 0:o[0].endOffset,null===(a=e.expression)||void 0===a||null===(i=a[e.expression.length-1])||void 0===i||null===(p=i.location)||void 0===p?void 0:p.endOffset,e.LBracket[0].endOffset])}}memberCallSubExpression(e){throw new Error("unexpected memberCallSubExpression")}dotMemberExpression(e){throw new Error("unexpected dotMemberExpression")}callArguments(e){throw new Error("unexpected callArguments")}};function ke(e){try{return{value:be.visit(e)}}catch(t){return{error:{type:p.UnexpectedError,error:(0,o.tg)(t),offset:0}}}}var Te=n(99036),Oe=n(29477),Ee=n(45953),we=n(21202),Ce=n(19889),Ue=n(70203),Pe=n(97880),Me=n(69282),Ne=n.n(Me),Le=n(32918),Fe=n(76725),Ae=n(2072),Be=n(4615),Se=n(63143);function Re(e,t){return{name:e,eval:function*(e,n){return{type:"number",value:t}},returnType:{type:"number"},iconType:{type:"number"}}}function Ie(e,t){return{name:e,eval:function*(e,n){const[r]=e;return Ne()("number"===r.type),{type:"number",value:t(r.value)}},parameters:{expected:[{name:"input",type:{type:"number"}}]},returnType:{type:"number"},iconType:{type:"number"}}}const $e=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"];function Ve(e,t){const n=(0,f.PX)(e,t);if(!$e.includes(n))throw new c({type:u.DateInvalidDurationUnit,invalidUnit:n});return n}function De(e){return function*(t,n){const[r,o,a]=t;Ne()("date"===r.type&&"number"===o.type&&"text"===a.type);const i=(0,Ae.iS)(r.value,n.userTimeZone).start,s=e(i,o.value,Ve(a.value,n));return{type:"date",value:"date"===r.value.type||"daterange"===r.value.type?(0,Ae.hT)(s,n.userTimeZone):(0,Ae.CQ)(s,n.userTimeZone)}}}function We(e){return function*(t,n){const[r]=t;return Ne()("date"===r.type),{type:"number",value:e((0,Ae.iS)((0,Le.Ws)(r.value),n.userTimeZone,n.intl.locale).start)}}}const _e="currentValue",qe={expected:[{name:"list",type:{type:"array",of:{type:"unknown"}}},{name:"expression",type:{type:"expression"},augmentScope:e=>{var t;return{[_e]:"array"===(null===(t=e[0])||void 0===t?void 0:t.type)?e[0].of:{type:"unknown"}}}}]};function je(e,t,n){return(0,f.LD)(e.map((e=>Ye(t,{...n,values:[{kind:f.yp.Binding,id:_e,value:e},...n.values]}))))}const Ze={type:"undefined"},Je={joinText:{name:"joinText",eval:function*(e){const[t,...n]=e;return Ne()("text"===t.type),{type:"text",value:(0,Ue.Zx)((0,Fe.Z)(n.map((e=>(Ne()("text"===e.type),e.value))),(()=>t.value)).flat())}},parameters:{expected:[{name:"joiner",type:{type:"text"}}],varargs:[{name:"arg",type:{type:"text"}}]},returnType:{type:"text"},iconType:{type:"text"}},substring:{name:"substring",eval:function*(e,t){const[n,r,o]=e;return Ne()("text"===n.type&&"number"===r.type),{type:"text",value:[[(0,f.PX)(n.value,t).substring(r.value,"number"===(null==o?void 0:o.type)?o.value:void 0)]]}},parameters:{expected:[{name:"target",type:{type:"text"}},{name:"startIndex",type:{type:"number"}},{name:"endIndex",optional:!0,type:{type:"number"}}]},returnType:{type:"text"},iconType:{type:"text"}},length:{name:"length",eval:function*(e,t){const[n]=e;return"array"===n.type?{type:"number",value:n.values.length}:(Ne()("text"===n.type),{type:"number",value:n.value.reduce(((e,t)=>e+(0,Ue.J1)(t)),0)})},parameters:{expected:[{name:"input",type:[{type:"text"},{type:"array",of:{type:"unknown"}}]}]},returnType:{type:"number"},iconType:{type:"text"}},format:{name:"format",eval:function*(e,t){const[n]=e;return Ne()("text"===n.type),{type:"text",value:(0,Ue.TP)((0,f.PX)(n.value,t))}},parameters:{expected:[{name:"input",type:{type:"text"}}]},returnType:{type:"text"},iconType:{type:"text"}},contains:{name:"contains",eval:function*(e,t){const[n,r]=e;return Ne()("text"===n.type&&"text"===r.type),{type:"checkbox",value:(0,f.PX)(n.value,t).includes((0,f.PX)(r.value,t))}},parameters:{expected:[{name:"input",type:{type:"text"}},{name:"searchString",type:{type:"text"}}]},returnType:{type:"checkbox"},iconType:{type:"text"}},replace:{name:"replace",eval:function*(e,t){const[n,r,o]=e;return Ne()("text"===n.type&&"text"===r.type),{type:"text",value:(0,Ue.TP)((0,f.PX)(n.value,t).replace(new RegExp((0,f.PX)(r.value,t)),"text"===(null==o?void 0:o.type)?(0,f.PX)(o.value,t):""))}},parameters:{expected:[{name:"input",type:{type:"text"}},{name:"pattern",type:{type:"text"}},{name:"replacement",optional:!0,type:{type:"text"}}]},returnType:{type:"text"},iconType:{type:"text"}},replaceAll:{name:"replaceAll",eval:function*(e,t){const[n,r,o]=e;return Ne()("text"===n.type&&"text"===r.type),{type:"text",value:(0,Ue.TP)((0,f.PX)(n.value,t).replace(new RegExp((0,f.PX)(r.value,t),"g"),"text"===(null==o?void 0:o.type)?(0,f.PX)(o.value,t):""))}},parameters:{expected:[{name:"input",type:{type:"text"}},{name:"pattern",type:{type:"text"}},{name:"replacement",optional:!0,type:{type:"text"}}]},returnType:{type:"text"},iconType:{type:"text"}},test:{name:"test",eval:function*(e,t){const[n,r]=e;return Ne()("text"===n.type&&"text"===r.type),{type:"checkbox",value:new RegExp((0,f.PX)(r.value,t)).test((0,f.PX)(n.value,t))}},parameters:{expected:[{name:"input",type:{type:"text"}},{name:"pattern",type:{type:"text"}}]},returnType:{type:"text"},iconType:{type:"text"}},empty:{name:"empty",eval:function*(e,t){const[n]=e;return{type:"checkbox",value:"array"===n.type?0===n.values.length:!(0,f.vh)(n)}},parameters:{expected:[{name:"input",type:{type:"unknown"}}]},returnType:{type:"checkbox"},iconType:{type:"unknown"}},toNumber:{name:"toNumber",eval:function*(e,t){const[n]=e;switch(n.type){case"number":return n;case"checkbox":return{type:"number",value:n.value?1:0};case"text":{const e=(0,f.PX)(n.value,t),r=parseFloat(e);return(0,Se.hj)(r)?{type:"number",value:parseFloat(e)}:Ze}case"date":return{type:"number",value:(0,Ae.iS)(n.value,t.userTimeZone).start.valueOf()};default:return Ze}},parameters:{expected:[{name:"input",type:{type:"unknown"}}]},returnType:{type:"number"},iconType:{type:"number"}},e:Re("e",Math.E),pi:Re("pi",Math.PI),abs:Ie("abs",Math.abs),ceil:Ie("ceil",Math.ceil),floor:Ie("floor",Math.floor),round:Ie("round",Math.round),sqrt:Ie("cbrt",Math.sqrt),cbrt:Ie("cbrt",Math.cbrt),exp:Ie("exp",Math.exp),ln:Ie("ln",Math.log),log10:Ie("log10",Math.log10),log2:Ie("log2",Math.log2),sign:Ie("sign",Math.sign),min:{name:"min",eval:function*(e,t){const n=e;return{type:"number",value:Math.min(...n.map((e=>(Ne()("number"===e.type),e.value))))}},parameters:{expected:[{name:"arg",type:{type:"number"}}],varargs:[{name:"arg",type:{type:"number"}}]},returnType:{type:"number"},iconType:{type:"number"}},max:{name:"max",eval:function*(e,t){const n=e;return{type:"number",value:Math.max(...n.map((e=>(Ne()("number"===e.type),e.value))))}},parameters:{expected:[{name:"arg",type:{type:"number"}}],varargs:[{name:"arg",type:{type:"number"}}]},returnType:{type:"number"},iconType:{type:"number"}},dateStart:{name:"dateStart",eval:function*(e,t){const[n]=e;return Ne()("date"===n.type),{type:"date",value:(0,Le.Ws)(n.value)}},parameters:{expected:[{name:"input",type:{type:"date"}}]},returnType:{type:"date"},iconType:{type:"date"}},dateEnd:{name:"dateEnd",eval:function*(e,t){const[n]=e;return Ne()("date"===n.type),{type:"date",value:(0,Le.S$)(n.value)}},parameters:{expected:[{name:"input",type:{type:"date"}}]},returnType:{type:"date"},iconType:{type:"date"}},now:{name:"now",eval:function*(e,t){return{type:"date",value:(0,Ae.R_)(t.userTimeZone)}},parameters:{},returnType:{type:"date"},iconType:{type:"date"}},timestamp:{name:"timestamp",eval:function*(e,t){const[n]=e;return Ne()("date"===n.type),{type:"number",value:(0,Ae.uO)(n.value,t.userTimeZone)}},parameters:{expected:[{name:"input",type:{type:"date"}}]},returnType:{type:"number"},iconType:{type:"date"}},fromTimestamp:{name:"fromTimestamp",eval:function*(e,t){const[n]=e;return Ne()("number"===n.type),{type:"date",value:(0,Ae.CQ)(n.value,t.userTimeZone)}},parameters:{expected:[{name:"input",type:{type:"number"}}]},returnType:{type:"date"},iconType:{type:"date"}},dateAdd:{name:"dateAdd",eval:De(((e,t,n)=>e.add(t,n).valueOf())),parameters:{expected:[{name:"input",type:{type:"date"}},{name:"num",type:{type:"number"}},{name:"unit",type:{type:"text"}}]},returnType:{type:"date"},iconType:{type:"date"}},dateSubtract:{name:"dateSubtract",eval:De(((e,t,n)=>e.subtract(t,n).valueOf())),parameters:{expected:[{name:"input",type:{type:"date"}},{name:"num",type:{type:"number"}},{name:"unit",type:{type:"text"}}]},returnType:{type:"date"},iconType:{type:"date"}},dateBetween:{name:"dateBetween",eval:function*(e,t){const[n,r,o]=e;Ne()("date"===n.type&&"date"===r.type&&"text"===o.type);const a=(0,Ae.iS)(n.value,t.userTimeZone).start,i=(0,Ae.iS)(r.value,t.userTimeZone).start,s=Ve(o.value,t);return{type:"number",value:a.diff(i,s).valueOf()}},parameters:{expected:[{name:"left",type:{type:"date"}},{name:"right",type:{type:"date"}},{name:"unit",type:{type:"text"}}]},returnType:{type:"number"},iconType:{type:"date"}},formatDate:{name:"formatDate",eval:function*(e,t){const[n,r]=e;Ne()("date"===n.type&&"text"===r.type);const o=(0,Ae.iS)((0,Le.Ws)(n.value),t.userTimeZone,t.intl.locale).start;return{type:"text",value:(0,Ue.TP)(o.format((0,f.PX)(r.value,t)))}},parameters:{expected:[{name:"date",type:{type:"date"}},{name:"format",type:{type:"text"}}]},returnType:{type:"text"},iconType:{type:"date"}},minute:{name:"minute",eval:We((e=>e.minutes())),parameters:{expected:[{name:"date",type:{type:"date"}}]},returnType:{type:"number"},iconType:{type:"date"}},hour:{name:"hour",eval:We((e=>e.hours())),parameters:{expected:[{name:"date",type:{type:"date"}}]},returnType:{type:"number"},iconType:{type:"date"}},day:{name:"day",eval:We((e=>e.days())),parameters:{expected:[{name:"date",type:{type:"date"}}]},returnType:{type:"number"},iconType:{type:"date"}},date:{name:"date",eval:We((e=>e.date())),parameters:{expected:[{name:"date",type:{type:"date"}}]},returnType:{type:"number"},iconType:{type:"date"}},month:{name:"month",eval:We((e=>e.month())),parameters:{expected:[{name:"date",type:{type:"date"}}]},returnType:{type:"number"},iconType:{type:"date"}},year:{name:"year",eval:We((e=>e.year())),parameters:{expected:[{name:"date",type:{type:"date"}}]},returnType:{type:"number"},iconType:{type:"date"}},if:{name:"if",eval:function*(e,t){const[n,r,o]=e;return Ne()("checkbox"===n.type),n.value?yield*Ye(r,t):yield*Ye(o,t)},parameters:{expected:[{name:"condition",type:{type:"checkbox"}},{name:"ifTrue",type:{type:"expression"}},{name:"ifFalse",type:{type:"expression"}}]},returnType:e=>{let[t,n,r]=e;return void 0!==n&&void 0!==r&&(0,f.Jy)(n,r)?n:{type:"unknown"}},iconType:{type:"checkbox"}},ifs:{name:"ifs",parameters:{expected:[{name:"condition",type:{type:"expression"}},{name:"ifTrue",type:{type:"expression"}}],varargs:[{name:"args",type:{type:"expression"}}]},returnType:e=>{if(e.length<2)return{type:"unknown"};const t=e[1];let n=2;for(;n<e.length-1;n+=2)if(!(0,f.Jy)(e[n+1],t))return{type:"unknown"};if(n<e.length){const r=e[n];if(!(0,f.Jy)(r,t))return{type:"unknown"}}return t},eval:function*(e,t){const n=e;let r=0;for(;r<n.length-1;r+=2){const e=yield*Ye(n[r],t);if((0,f.vh)(e))return yield*Ye(n[r+1],t)}return r<n.length?yield*Ye(n[r],t):Ze},iconType:{type:"checkbox"}},sum:{name:"sum",eval:function*(e,t){return{type:"number",value:e.reduce(((e,t)=>e+("number"===t.type?t.value:"array"===t.type?t.values.reduce(((e,t)=>e+("number"===t.type?t.value:0)),0):0)),0)}},parameters:{varargs:[{name:"value",type:[{type:"number"},{type:"array",of:{type:"number"}}]}]},returnType:{type:"number"},iconType:{type:"number"}},at:{name:"at",eval:function*(e,t){const[n,r]=e;return Ne()("array"===n.type&&"number"===r.type),void 0!==n.values[r.value]?n.values[r.value]:Ze},parameters:{expected:[{name:"list",type:{type:"array",of:{type:"unknown"}}},{name:"index",type:{type:"number"}}]},returnType:e=>{let[t]=e;return"array"===(null==t?void 0:t.type)?t.of:{type:"unknown"}},iconType:{type:"array",of:{type:"unknown"}}},concat:{name:"concat",eval:function*(e){return{type:"array",values:e.flatMap((e=>(Ne()("array"===e.type),e.values)))}},parameters:{varargs:[{name:"arg",type:{type:"array",of:{type:"unknown"}}}]},returnType:e=>{var t;if("array"===(null===(t=e[0])||void 0===t?void 0:t.type))return{type:"array",of:{type:"unknown"}};const n=e[0];for(let r=1;r<e.length;r++)if(void 0!==e[r]&&!(0,f.Jy)(e[r],n))return{type:"array",of:{type:"unknown"}};return n},iconType:{type:"array",of:{type:"unknown"}}},every:{name:"every",eval:function*(e,t){const[n,r]=e;Ne()("array"===n.type);return{type:"checkbox",value:(yield*je(n.values,r,t)).every((e=>(0,f.vh)(e)))}},parameters:qe,returnType:{type:"checkbox"},iconType:{type:"array",of:{type:"unknown"}}},filter:{name:"filter",eval:function*(e,t){const[n,r]=e;Ne()("array"===n.type);const o=yield*je(n.values,r,t);return{type:"array",values:n.values.filter(((e,t)=>(0,f.vh)(o[t])))}},parameters:qe,returnType:e=>{let[t,n]=e;return"array"===(null==t?void 0:t.type)?t:{type:"unknown"}},iconType:{type:"array",of:{type:"unknown"}}},find:{name:"find",eval:function*(e,t){const[n,r]=e;Ne()("array"===n.type);const o=yield*je(n.values,r,t);return n.values.find(((e,t)=>(0,f.vh)(o[t])))??{type:"undefined"}},parameters:qe,returnType:e=>{let[t,n]=e;return"array"===(null==t?void 0:t.type)?t.of:{type:"unknown"}},iconType:{type:"text"}},findIndex:{name:"findIndex",eval:function*(e,t){const[n,r]=e;Ne()("array"===n.type);return{type:"number",value:(yield*je(n.values,r,t)).findIndex((e=>(0,f.vh)(e)))}},parameters:qe,returnType:e=>{let[t,n]=e;return"array"===(null==t?void 0:t.type)?t.of:{type:"unknown"}},iconType:{type:"text"}},first:{name:"first",eval:function*(e,t){const[n]=e;return Ne()("array"===n.type),n.values.length>0?n.values[0]:Ze},parameters:{expected:[{name:"list",type:{type:"array",of:{type:"unknown"}}}]},returnType:e=>{let[t]=e;return"array"===(null==t?void 0:t.type)?t.of:{type:"unknown"}},iconType:{type:"array",of:{type:"unknown"}}},flat:{name:"flat",eval:function*(e,t){const[n]=e;Ne()("array"===n.type);const r=[];for(const o of n.values)"array"===o.type?r.push(...o.values):r.push(o);return{type:"array",values:r}},parameters:{expected:[{name:"list",type:{type:"array",of:{type:"unknown"}}}]},returnType:e=>{let[t]=e,n={type:"unknown"};return"array"===(null==t?void 0:t.type)&&(n="array"===t.of.type?t.of.of:t.of),{type:"array",of:n}},iconType:{type:"array",of:{type:"unknown"}}},join:{name:"join",eval:function*(e){const[t,n]=e;return Ne()("array"===t.type&&"text"===n.type),{type:"text",value:(0,Ue.Zx)((0,Fe.Z)(t.values.map((e=>(Ne()("text"===e.type),e.value))),(()=>n.value)).flat())}},parameters:{expected:[{name:"input",type:{type:"array",of:{type:"text"}}},{name:"joiner",type:{type:"text"}}]},returnType:{type:"text"},iconType:{type:"array",of:{type:"unknown"}}},includes:{name:"includes",eval:function*(e,t){const[n,r]=e;Ne()("array"===n.type);for(const o of n.values)if((0,f.Jr)(o,r))return{type:"checkbox",value:!0};return{type:"checkbox",value:!1}},parameters:{expected:[{name:"list",type:{type:"array",of:{type:"unknown"}}},{name:"needle",type:{type:"unknown"}}]},returnType:{type:"checkbox"},iconType:{type:"array",of:{type:"unknown"}}},last:{name:"last",eval:function*(e,t){const[n]=e;return Ne()("array"===n.type),n.values.length>0?n.values[n.values.length-1]:Ze},parameters:{expected:[{name:"list",type:{type:"array",of:{type:"unknown"}}}]},returnType:e=>{let[t]=e;return"array"===(null==t?void 0:t.type)?t.of:{type:"unknown"}},iconType:{type:"array",of:{type:"unknown"}}},map:{name:"map",eval:function*(e,t){const[n,r]=e;return Ne()("array"===n.type),{type:"array",values:yield*je(n.values,r,t)}},parameters:qe,returnType:e=>{let[t,n]=e;return{type:"array",of:n??{type:"unknown"}}},iconType:{type:"array",of:{type:"text"}}},reverse:{name:"reverse",eval:function*(e,t){const[n]=e;Ne()("array"===n.type);return{type:"array",values:[...n.values].reverse()}},parameters:{expected:[{name:"list",type:{type:"array",of:{type:"unknown"}}}]},returnType:e=>{let[t]=e;return"array"===t.type?t:{type:"array",of:{type:"unknown"}}},iconType:{type:"array",of:{type:"unknown"}}},slice:{name:"slice",eval:function*(e,t){const[n,r,o]=e;return Ne()("array"===n.type&&"number"===r.type),{type:"array",values:n.values.slice(r.value,"number"===(null==o?void 0:o.type)?o.value:void 0)}},parameters:{expected:[{name:"list",type:{type:"array",of:{type:"unknown"}}},{name:"startIndex",type:{type:"number"}},{name:"endIndex",optional:!0,type:{type:"number"}}]},returnType:e=>{let[t]=e;return"array"===(null==t?void 0:t.type)?t:{type:"array",of:{type:"unknown"}}},iconType:{type:"array",of:{type:"unknown"}}},some:{name:"some",eval:function*(e,t){const[n,r]=e;Ne()("array"===n.type);return{type:"checkbox",value:(yield*je(n.values,r,t)).some((e=>(0,f.vh)(e)))}},parameters:qe,returnType:{type:"checkbox"},iconType:{type:"array",of:{type:"unknown"}}},sort:{name:"sort",eval:function*(e,t){const[n]=e;Ne()("array"===n.type);return{type:"array",values:[...n.values].sort(((e,n)=>(0,f.b7)(e,n,t)))}},parameters:{expected:[{name:"list",type:{type:"array",of:{type:"unknown"}}}]},returnType:e=>{let[t]=e;return"array"===t.type?t:{type:"array",of:{type:"unknown"}}},iconType:{type:"array",of:{type:"unknown"}}},unique:{name:"unique",eval:function*(e,t){const[n]=e;Ne()("array"===n.type);const r=[];return n.values.forEach((e=>{r.some((t=>(0,f.Jr)(t,e)))||r.push(e)})),{type:"array",values:r}},parameters:{expected:[{name:"list",type:{type:"array",of:{type:"unknown"}}}]},returnType:e=>{let[t]=e;return"array"===t.type?t:{type:"array",of:{type:"unknown"}}},iconType:{type:"array",of:{type:"unknown"}}},_toPlainText:{name:"_toPlainText",eval:function*(e,t){const[n]=e;return Ne()("text"===n.type),{type:"text",value:(0,Ue.TP)((0,f.PX)(n.value,t))}},parameters:{expected:[{name:"input",type:{type:"text"}}]},returnType:()=>({type:"text"}),iconType:{type:"text"}},_toText:{name:"_toText",eval:function*(e,t){const[n]=e;return{type:"text",value:(0,f.j4)(n)}},parameters:{expected:[{name:"input",type:{type:"unknown"}}]},returnType:()=>({type:"text"}),iconType:{type:"text"}},_let:{name:"_let",eval:function*(e,t){const[n,r,o]=e;if(n.kind!==s.Identifier)throw new c({type:u.LetBindingNameNotIdentifier,node:n});return yield*Ye(o,{...t,values:[{kind:f.yp.Binding,id:n.text,value:yield*Ye(r,t)},...t.values]})},parameters:{expected:[{name:"identifier",type:{type:"expression"}},{name:"value",type:{type:"expression"}},{name:"expression",type:{type:"expression"}}]},returnType:e=>{let[t,n,r]=e;return r??{type:"unknown"}},iconType:{type:"text"}},_idDeprecated:{name:"_idDeprecated",eval:function*(e,t){var n;const r=null===(n=t.values.find((e=>e.kind===f.yp.ThisRow)))||void 0===n?void 0:n.value;if("block"!==(null==r?void 0:r.type))throw new c({type:u.TryingToGetIdWithoutThisRow});return{type:"text",value:(0,Ue.TP)((0,Be.cj)(r.value.id))}},returnType:()=>({type:"text"}),iconType:{type:"text"}}};function Xe(e,t,n){if("number"!==t.type&&"undefined"!==t.type)throw new d({type:l.CannotDoMathOnType,op:n,operand:e,valueType:t.type})}function*Ye(e,t){switch(e.kind){case s.Number:return{type:"number",value:parseFloat(e.text)};case s.String:return{type:"text",value:[[e.text.replace(/\\([\\"])/g,"$1")]]};case s.Boolean:return{type:"checkbox",value:"true"===e.text.toLowerCase()};case s.NotionToken:{const r=e.token;switch(r.type){case f.Oy.Checkbox:return{type:"checkbox",value:r.checked};case f.Oy.BlockProperty:{const n=t.values.find((e=>e.kind===f.yp.ThisRow));if("block"!==(null==n?void 0:n.value.type))throw new d({type:l.MissingThisRow,node:e});const o=n.value.value,a=(yield{recordPointers:[o]}).recordMap.get(o);if(void 0===a)throw new d({type:l.MissingThisRow,node:e});if(void 0===r.collection)return(0,f.SQ)(a,r.property);const s={table:i.v,id:a.parent_id,spaceId:a.space_id};if(!(0,Ee.qo)(r.collection,s))throw new d({type:l.ThisRowBlockPropertyMismatchCollection,node:e,thisRowCollection:s});const p=(yield{recordPointers:[s]}).recordMap.get(s),u=(0,Te.oC)(p),y=u[r.property];if(void 0===y)throw new d({type:l.MissingSchemaPropertyOnThisRow,node:e,collectionId:a.parent_id,property:r.property});return yield*(0,f.iC)(a,r.property,u,y,t)}case f.Oy.Block:return{type:"block",value:{table:we.iU,id:r.blockId,spaceId:r.spaceId}};case f.Oy.ContextValue:{var n;const o=null===(n=t.values.find((e=>e.kind===f.yp.ContextValue&&e.id===(0,f.Kv)(r.valueId))))||void 0===n?void 0:n.value;if(void 0===o)throw new d({type:l.MissingContextVariable,node:e,valueId:r.valueId});return o}case f.Oy.Date:return{type:"date",value:r.date};case f.Oy.Person:return{type:"person",value:{table:Ce.KJ,id:r.userId}};case f.Oy.UserProperty:throw new d({type:l.NonMemberUserProperty,node:e});default:(0,Pe.t1)(r)}break}case s.Identifier:{var r;const n=null===(r=t.values.find((t=>t.kind===f.yp.Binding&&t.id===e.text)))||void 0===r?void 0:r.value;if(void 0!==n)return n;if(e.text in Je)return{type:"function",function:Je[e.text]};throw new d({type:l.IdentifierNotFound,node:e})}case s.Array:return{type:"array",values:yield*(0,f.LD)(e.elements.map((e=>Ye(e,t))))};case s.Conditional:{const n=yield*Ye(e.condition,t);return(0,f.vh)(n)?yield*Ye(e.expIfTrue,t):yield*Ye(e.expIfFalse,t)}case s.LogicalOr:{const[n,r]=yield*(0,f.LD)([Ye(e.lhs,t),Ye(e.rhs,t)]);return{type:"checkbox",value:(0,f.vh)(n)||(0,f.vh)(r)}}case s.LogicalAnd:{const[n,r]=yield*(0,f.LD)([Ye(e.lhs,t),Ye(e.rhs,t)]);return{type:"checkbox",value:(0,f.vh)(n)&&(0,f.vh)(r)}}case s.Equality:{const[n,r]=yield*(0,f.LD)([Ye(e.lhs,t),Ye(e.rhs,t)]);switch(e.op){case"=":return{type:"checkbox",value:(0,f.Jr)(n,r)};case"!=":return{type:"checkbox",value:!(0,f.Jr)(n,r)}}break}case s.Relational:{const[n,r]=yield*(0,f.LD)([Ye(e.lhs,t),Ye(e.rhs,t)]);if("date"===n.type&&"date"===r.type){const o=(0,f.SU)(n.value,r.value,t.userTimeZone);switch(e.op){case"<":return{type:"checkbox",value:o<0};case"<=":return{type:"checkbox",value:o<=0};case">":return{type:"checkbox",value:o>0};case">=":return{type:"checkbox",value:o>=0}}}if("number"===n.type&&"number"===r.type)switch(e.op){case"<":return{type:"checkbox",value:n.value<r.value};case"<=":return{type:"checkbox",value:n.value<=r.value};case">":return{type:"checkbox",value:n.value>r.value};case">=":return{type:"checkbox",value:n.value>=r.value}}throw new d({type:l.CannotRelativelyCompareTypes,lhs:e.lhs,rhs:e.rhs,lhsType:n.type,rhsType:r.type})}case s.Additive:{const[n,r]=yield*(0,f.LD)([Ye(e.lhs,t),Ye(e.rhs,t)]);switch(e.op){case"+":return"number"===n.type&&"number"===r.type?{type:"number",value:n.value+r.value}:{type:"text",value:(0,Ue.Zx)((0,f.j4)(n).concat((0,f.j4)(r)))};case"-":if(Xe(e.lhs,n,e.op),Xe(e.rhs,r,e.op),"number"===n.type&&"number"===r.type)return{type:"number",value:n.value-r.value}}return{type:"undefined"}}case s.Multiplicative:{const[n,r]=yield*(0,f.LD)([Ye(e.lhs,t),Ye(e.rhs,t)]);switch(Xe(e.lhs,n,e.op),Xe(e.rhs,r,e.op),e.op){case"*":if("number"===n.type&&"number"===r.type)return{type:"number",value:n.value*r.value};break;case"/":if("number"===n.type&&"number"===r.type)return{type:"number",value:n.value/r.value};break;case"%":if("number"===n.type&&"number"===r.type)return{type:"number",value:n.value%r.value}}return{type:"undefined"}}case s.Exponentiation:{const[n,r]=yield*(0,f.LD)([Ye(e.lhs,t),Ye(e.rhs,t)]);switch(Xe(e.lhs,n,e.op),Xe(e.rhs,r,e.op),e.op){case"^":if("number"===n.type&&"number"===r.type)return{type:"number",value:n.value**r.value}}return{type:"undefined"}}case s.Unary:{const n=yield*Ye(e.expression,t);switch(e.op){case"-":if("number"!==n.type)throw new d({type:l.UnaryMinusOnNonNumber,node:e.expression,expressionType:n.type});return{type:"number",value:-n.value};case"!":case"not":return{type:"checkbox",value:!(0,f.vh)(n)}}throw new Error("unexpected unary operator")}case s.Call:{const n=yield*Ye(e.expression,t);if("function"!==n.type)throw new d({type:l.CannotCallNonFunction,node:e,calleeType:n.type});const r=n.function,a=(0,f.P2)(r),i=void 0!==n.boundTarget?[n.boundTarget,...e.arguments]:e.arguments;if(i.length<a)throw new d({type:l.FunctionCallTooFewArguments,node:e,libraryFunction:r,numArguments:i.length});const s=yield*(0,f.LD)(i.map(((n,o)=>function*(e,t,n,r,o){const a=(0,f.J3)(r,n);if(void 0===a)throw new d({type:l.FunctionCallUnexpectedArgument,node:e,argument:t,libraryFunction:r,parameterIndex:n});if(!Array.isArray(a.type)&&"expression"===a.type.type)return t;const i=yield*Ye(t,o);if(!(0,f.mB)(i,a.type)){if(Array.isArray(a.type)?a.type.some((e=>"checkbox"===e.type)):"checkbox"===a.type.type)return{type:"checkbox",value:(0,f.vh)(i)};if(Array.isArray(a.type)?a.type.some((e=>"text"===e.type)):"text"===a.type.type)return{type:"text",value:(0,f.j4)(i)};throw new d({type:l.FunctionCallArgumentWrongType,node:e,argument:t,libraryFunction:r,parameterIndex:n,argumentType:i.type})}return i}(e,n,o,r,t))));try{return yield*r.eval(s,t)}catch(o){throw new d({type:l.LibraryFunctionExecutionError,node:e,libraryFunction:r,error:o})}}case s.UnifiedFunctionProperty:if(e.name in Je)return{type:"function",function:Je[e.name],boundTarget:e.expression};throw new d({type:l.UnifiedFunctionPropertyNotFound,node:e});case s.MemberBlockProperty:{const n=yield*Ye(e.expression,t);if("undefined"===n.type)return{type:"undefined"};if("block"!==n.type)throw new d({type:l.AccessingPropertyOnNonBlock,node:e,expressionValue:n});const r=(yield{recordPointers:[n.value]}).recordMap.get(n.value);if(void 0===r)throw new d({type:l.MissingDataDependencyBlock,node:e,blockPointer:n.value});if(void 0===e.propertyToken.collection)return(0,f.SQ)(r,e.propertyToken.property);const o={table:i.v,id:r.parent_id,spaceId:r.space_id};if(!(0,Ee.qo)(e.propertyToken.collection,o))throw new d({type:l.MemberPropertyMismatchCollection,node:e,blockCollection:o});const a=(yield{recordPointers:[o]}).recordMap.get(o),s=(0,Te.oC)(a),p=s[e.propertyToken.property];if(void 0===p)throw new d({type:l.MissingPropertyOnSchemaForMemberProperty,node:e});return yield*(0,f.iC)(r,e.propertyToken.property,s,p,t)}case s.MemberUserProperty:{const n=yield*Ye(e.expression,t);if("undefined"===n.type)return{type:"undefined"};if("person"!==n.type)throw new d({type:l.AccessingUserPropertyOnNonPerson,node:e,expressionValue:n});const r=(yield{recordPointers:[n.value]}).recordMap.get(n.value);if(void 0===r)throw new d({type:l.MissingDataDependencyPerson,node:e,personPointer:n.value});return(0,f.pp)(r,e.userProperty,t)}case s.RecoveryNode:throw new d({type:l.UnexpectedRecoveryNode,recovery:e});default:(0,Pe.t1)(e)}}async function Ke(e,t){try{const n=Ye(e,t);let r=n.next();for(;!r.done;){const e=t.handleDataRequest(r.value);r=n.next((0,Oe.tI)(e)?await e:e)}return{value:r.value}}catch(n){return n instanceof d?{error:n.info}:{error:{type:l.UnexpectedError,error:(0,o.tg)(n)}}}}function Qe(e){const t=(0,Ue.sP)(e);if(void 0!==t){const e=(0,Ue.vm)(t),n=(0,f.ij)(e.id);return`${f.Eb}${f.Oy.ContextValue}:${n}${f.Av}`}const n=(0,Ue.jR)(e);if(void 0!==n){const e=(0,Ue.px)(n);return void 0!==e.collection?`${f.Eb}${f.Oy.BlockProperty}:${e.property}:${e.collection.id}:${e.collection.spaceId}${f.Av}`:`${f.Eb}${f.Oy.BlockProperty}:${e.property}${f.Av}`}const r=(0,Ue.K9)(e);if(void 0!==r){const e=(0,Ue.Ot)(r);return o=e,`${f.Eb}${f.Oy.Date}:${(0,f.hM)(o)}${f.Av}`}var o;const a=(0,Ue.V8)(e);if(void 0!==a){const e=(0,Ue.yr)(a);if(void 0!==e)return`${f.Eb}${f.Oy.Block}:${e.id}${void 0!==e.spaceId?`:${e.spaceId}`:""}${f.Av}`}const i=(0,Ue.hH)(e);if(void 0!==i){const e=(0,Ue.zE)(i);return`${f.Eb}${f.Oy.Person}:${e}${f.Av}`}const s=(0,Ue.LV)(e);if(void 0!==s){const e=(0,Ue.dB)(s);return`${f.Eb}${f.Oy.UserProperty}:${e}${f.Av}`}}function ze(e){let t="";const n=[];return e.forEach((e=>{const r=Qe((0,Ue.hD)(e));if(void 0!==r)return t+=r,void n.push({type:"token",length:r.length});const o=(0,Ue.Wi)(e);t+=o,n.push({type:"code",length:o.length})})),[t,n]}function*Ge(e,t){switch(e.kind){case s.Number:return{node:{...e,type:{type:"number"},context:t},errors:[]};case s.String:return{node:{...e,type:{type:"text"},context:t},errors:[]};case s.Boolean:return{node:{...e,type:{type:"checkbox"},context:t},errors:[]};case s.NotionToken:{const o=e.token;switch(o.type){case f.Oy.Checkbox:return{node:{...e,type:{type:"checkbox"},context:t},errors:[]};case f.Oy.BlockProperty:{var n;const r=null===(n=t.valueTypes.find((e=>e.kind===f.yp.ThisRow)))||void 0===n?void 0:n.type;if(void 0===r)return{node:{...e,type:{type:"unknown"},context:t},errors:[{type:y.ThisRowTypeNotFound,node:e}]};if("block"!==r.type||void 0===r.collection)return{node:{...e,type:{type:"unknown"},context:t},errors:[{type:y.ThisRowNotBlockWithCollection,node:e}]};if(void 0===o.collection)return{node:{...e,type:f.dy[o.property],context:t},errors:[]};const a=(yield{recordPointers:[r.collection]}).recordMap.get(r.collection),i=(0,Te.oC)(a),s=i[o.property];if(void 0===s)return{node:{...e,type:{type:"unknown"},context:t},errors:[{type:y.MissingPropertyOnThisRow,node:e,token:o}]};const[p,u]=yield*(0,f.IP)(o.property,i,s);return{node:{...e,type:p,context:t},errors:!0===u?[{type:y.MemberPropertyButtonType,node:e,token:o}]:[]}}case f.Oy.ContextValue:{var r;const n=null===(r=t.valueTypes.find((e=>e.kind===f.yp.ContextValue&&e.id===(0,f.Kv)(o.valueId))))||void 0===r?void 0:r.type;return void 0===n?{node:{...e,type:{type:"unknown"},context:t},errors:[{type:y.MissingContextVariable,node:e,token:o}]}:{node:{...e,type:n,context:t},errors:[]}}case f.Oy.Block:{const n={table:we.iU,id:o.blockId,spaceId:o.spaceId},r=(yield{recordPointers:[n]}).recordMap.get(n);if(void 0===r)return{node:{...e,type:{type:"unknown"},context:t},errors:[{type:y.MissingBlockValue,node:e,token:o}]};const a=r.parent_table===i.v?{table:r.parent_table,id:r.parent_id,spaceId:r.space_id}:void 0;return{node:{...e,type:{type:"block",collection:a},context:t},errors:[]}}case f.Oy.Person:return{node:{...e,type:{type:"person"},context:t},errors:[]};case f.Oy.UserProperty:return{node:{...e,type:{type:"unknown"},context:t},errors:[{type:y.NonMemberUserProperty,node:e,token:o}]};case f.Oy.Date:return{node:{...e,type:{type:"date"},context:t},errors:[]};default:(0,Pe.t1)(o)}break}case s.Array:{const n=yield*(0,f.LD)(e.elements.map((e=>Ge(e,t))));let r={type:"unknown"};if(n.length>0){r=n[0].node.type;for(let e=1;e<n.length;e++)if(!(0,f.Jy)(r,n[e].node.type)){r={type:"unknown"};break}}return{node:{...e,elements:n.map((e=>e.node)),type:{type:"array",of:r},context:t},errors:n.flatMap((e=>e.errors))}}case s.Identifier:{var o;const n=null===(o=t.valueTypes.find((t=>t.kind===f.yp.Binding&&t.id===e.text)))||void 0===o?void 0:o.type;if(void 0!==n)return{node:{...e,type:n,context:t},errors:[]};const r=Je[e.text];return void 0===r?{node:{...e,type:{type:"unknown"},context:t},errors:[{type:y.UndefinedIdentifier,node:e}]}:{node:{...e,type:{type:"function",libraryFunction:r},context:t},errors:[]}}case s.Conditional:{const n=yield*Ge(e.condition,t),r=yield*Ge(e.expIfTrue,t),o=void 0!==e.expIfFalse?yield*Ge(e.expIfFalse,t):void 0;let a={type:"unknown"};return void 0===r.node.type||void 0!==(null==o?void 0:o.node.type)&&!(0,f.Jy)(r.node.type,o.node.type)||(a=r.node.type),{node:{...e,condition:n.node,expIfTrue:r.node,expIfFalse:null==o?void 0:o.node,type:a,context:t},errors:[...n.errors,...r.errors??[],...(null==o?void 0:o.errors)??[]]}}case s.LogicalOr:case s.LogicalAnd:case s.Equality:case s.Relational:{const n=yield*Ge(e.lhs,t),r=yield*Ge(e.rhs,t),o=[...n.errors,...r.errors];if(e.kind===s.Relational){const t=n.node.type,a=r.node.type;"unknown"===t.type||"unknown"===a.type||t.type===a.type&&["number","date"].includes(t.type)||o.push({type:y.CannotRelativelyCompareTypes,node:e,lhsType:t,rhsType:a})}return{node:{...e,lhs:n.node,rhs:r.node,type:{type:"checkbox"},context:t},errors:o}}case s.Additive:case s.Multiplicative:case s.Exponentiation:{const n=yield*Ge(e.lhs,t),r=yield*Ge(e.rhs,t),o=[...n.errors,...r.errors];if("+"===e.op)return"number"===n.node.type.type&&"number"===r.node.type.type?{node:{...e,lhs:n.node,rhs:r.node,type:{type:"number"},context:t},errors:o}:{node:{...e,lhs:n.node,rhs:r.node,type:["unknown","number"].includes(n.node.type.type)&&["unknown","number"].includes(r.node.type.type??"unknown")?{type:"unknown"}:{type:"text"},context:t},errors:o};const a=function(e,t,n){const r=t.type,o=(null==n?void 0:n.type)??{type:"unknown"};if(!["unknown","number"].includes(r.type)||!["unknown","number"].includes(o.type))return{type:y.CannotDoMathOnType,node:e,lhsType:r,rhsType:o}}(e,n.node,r.node);return void 0!==a&&o.push(a),{node:{...e,lhs:n.node,rhs:r.node,type:{type:"number"},context:t},errors:o}}case s.Unary:{const n=yield*Ge(e.expression,t),r=[...n.errors];let o;switch(e.op){case"-":["number","unknown"].includes(n.node.type.type)||r.push({type:y.UnaryMinusOnNonNumber,node:e,expression:n.node}),o={type:"number"};break;case"!":case"not":o={type:"checkbox"};break;default:(0,Pe.t1)(e)}return{node:{...e,expression:n.node,type:o,context:t},errors:r}}case s.Call:{const{node:n,errors:r}=yield*Ge(e.expression,t),o=[...r];if(n.kind===s.Identifier&&"_let"===n.text){var a;const r=[];for(let n=0;n<e.arguments.length;n++){const a=e.arguments[n];if(0===n)r[0]={...a,type:{type:"unknown"},context:t};else if(1===n){const{node:e,errors:i}=yield*Ge(a,t);r[n]=e,o.push(...i)}else if(2===n){var p,u;const i=(null===(p=e.arguments[0])||void 0===p?void 0:p.kind)===s.Identifier?e.arguments[0].text:void 0,{node:l,errors:y}=yield*Ge(a,void 0!==i?{...t,valueTypes:[{kind:f.yp.Binding,id:i,name:i,type:(null===(u=r[1])||void 0===u?void 0:u.type)??{type:"unknown"}},...t.valueTypes]}:t);r[n]=l,o.push(...y)}}return{node:{...e,expression:n,arguments:r,type:(null===(a=r[2])||void 0===a?void 0:a.type)??{type:"unknown"},context:t},errors:o}}["function","unknown"].includes(n.type.type)||o.push({type:y.CallingNotFunction,node:e,callee:n});const i="function"===n.type.type?n.type.libraryFunction:void 0,l="function"===n.type.type?n.type.boundTargetType:void 0;if(void 0!==i){const t=(0,f.P2)(i),n=e.arguments.length+(void 0!==l?1:0);n<t&&o.push({type:y.FunctionCallTooFewArguments,node:e,libraryFunction:i,numArguments:n,minNumParameters:t})}const c=[],d=[];void 0!==l&&d.push(l);for(let a=0;a<e.arguments.length;a++){const n=e.arguments[a],r=void 0!==l?a+1:a,s=void 0!==i?(0,f.J3)(i,r):void 0;if(void 0!==i&&void 0===s&&o.push({type:y.FunctionCallUnexpectedArgument,node:e,libraryFunction:i,argument:n,parameterIndex:r}),void 0!==(null==s?void 0:s.augmentScope)){const e=c.map((e=>(null==e?void 0:e.type)??{type:"unknown"})),r=s.augmentScope(void 0!==l?[l,...e]:e),{node:i,errors:p}=yield*Ge(n,{...t,valueTypes:[...Object.entries(r).map((e=>{let[t,n]=e;return{kind:f.yp.Binding,id:t,type:n}})),...t.valueTypes]});c[a]=i,d.push(i.type),o.push(...p)}else{const{node:r,errors:p}=yield*Ge(n,t);if(c[a]=r,void 0!==i&&void 0!==s){const t=(0,f.xK)(r.type,s.type);"boolean"==typeof t?(d.push(r.type),t||o.push({type:y.FunctionCallArgumentWrongType,node:e,libraryFunction:i,argument:r,expectedParameter:s})):d.push(t)}else d.push(r.type);o.push(...p)}}return{node:{...e,expression:n,arguments:c,type:void 0!==i?"function"==typeof i.returnType?i.returnType(d):i.returnType:{type:"unknown"},context:t},errors:o}}case s.UnifiedFunctionProperty:{const n=Je[e.name],{node:r,errors:o}=yield*Ge(e.expression,t),a=[...o];let i={type:"unknown"};if(void 0===n)a.push({type:y.UnifiedFunctionCannotFindFunction,node:e,name:e.name});else{const t=(0,f.J3)(n,0);if(void 0===t)a.push({type:y.UnifiedFunctionNoArguments,node:e,libraryFunction:n});else{const o=(0,f.xK)(r.type,t.type);"boolean"==typeof o?(i=r.type,o||a.push({type:y.UnifiedFunctionTargetWrongType,node:e,expression:r,libraryFunction:n})):i=o}}return{node:{...e,expression:r,type:void 0!==n?{type:"function",boundTargetType:i,libraryFunction:n}:{type:"unknown"},context:t},errors:a}}case s.MemberBlockProperty:{const{node:n,errors:r}=yield*Ge(e.expression,t),o=[...r];let a;if("block"===n.type.type)if(void 0===e.propertyToken.collection)a=f.dy[e.propertyToken.property];else{const t=(yield{recordPointers:[e.propertyToken.collection]}).recordMap.get(e.propertyToken.collection),r=(0,Te.oC)(t),i=r[e.propertyToken.property];if(void 0===i)o.push({type:y.MemberPropertyMissing,node:e,token:e.propertyToken});else if(void 0!==n.type.collection)if((0,Ee.qo)(e.propertyToken.collection,n.type.collection)){const t=yield*(0,f.IP)(e.propertyToken.property,r,i);a=t[0],!0===t[1]&&o.push({type:y.MemberPropertyButtonType,node:e,token:e.propertyToken})}else o.push({type:y.MemberPropertyMismatchCollection,node:e,token:e.propertyToken})}else"unknown"!==n.type.type&&o.push({type:y.MemberPropertyTargetNotBlock,node:e,expression:n});return{node:{...e,expression:n,type:a??{type:"unknown"},context:t},errors:o}}case s.MemberUserProperty:{const{node:n,errors:r}=yield*Ge(e.expression,t),o=[...r];let a;return"person"===n.type.type?a=f.VJ[e.userProperty]:"unknown"!==n.type.type&&o.push({type:y.MemberUserPropertyTargetNotPerson,node:e,expression:n}),{node:{...e,expression:n,type:a??{type:"unknown"},context:t},errors:o}}case s.RecoveryNode:return{node:{...e,type:{type:"unknown"},context:t},errors:[]};default:(0,Pe.t1)(e)}}async function He(e,t){const n=Ge(e,t);let r=n.next();for(;!r.done;){const e=t.handleDataRequest(r.value);r=n.next((0,Oe.tI)(e)?await e:e)}return r.value}function et(e,t){if(t<e.startOffset||t>e.endOffset+1)return[];const n=e.kind;switch(n){case s.Number:case s.String:case s.Boolean:case s.NotionToken:case s.Identifier:case s.RecoveryNode:return[e];case s.Conditional:{const n=et(e.condition,t);if(n.length>0)return[e,...n];const r=et(e.expIfTrue,t);if(r.length>0)return[e,...r];if(void 0!==e.expIfFalse){const n=et(e.expIfFalse,t);if(n.length>0)return[e,...n]}return[e]}case s.LogicalOr:case s.LogicalAnd:case s.Equality:case s.Relational:case s.Additive:case s.Multiplicative:case s.Exponentiation:{const n=et(e.lhs,t);if(n.length>0)return[e,...n];const r=et(e.rhs,t);return r.length>0?[e,...r]:[e]}case s.Array:for(const n of e.elements){const r=et(n,t);if(r.length>0)return[e,...r]}return[e];case s.Unary:{const n=et(e.expression,t);return n.length>0?[e,...n]:[e]}case s.Call:{const n=et(e.expression,t);if(n.length>0)return[e,...n];for(const r of e.arguments){const n=et(r,t);if(n.length>0)return[e,...n]}return[e]}case s.UnifiedFunctionProperty:case s.MemberBlockProperty:case s.MemberUserProperty:{const n=et(e.expression,t);return n.length>0?[e,...n]:[e]}default:(0,Pe.t1)(n)}}async function tt(e,t,n){const r=[];if(void 0!==e){const o=t.handleDataRequest({recordPointers:[e]}),a=((0,Oe.tI)(o)?await o:o).recordMap.get(e),i=(0,Te.oC)(a);for(const[t,s]of Object.entries(i))"title"!==t&&(""===n||s.name.startsWith(n))&&r.push({kind:f.WY.Token,name:s.name,token:{type:f.Oy.BlockProperty,property:t,collection:e}})}for(const o of Object.values(f.vz))(""===n||o.startsWith(n))&&r.push({kind:f.WY.Token,token:{type:f.Oy.BlockProperty,property:o,collection:void 0}});return r}function nt(e,t){return""===e||t.toLowerCase().startsWith(e.toLowerCase())}async function rt(e,t,n){const r=[],o=new Set;if(void 0===n){var a;t.valueTypes.forEach((t=>{if(t.kind===f.yp.Binding){const n=t.id;!o.has(n)&&nt(e,t.id)&&(r.push({kind:f.WY.Binding,text:n,type:t.type}),o.add(n))}}));const n=null===(a=t.valueTypes.find((e=>e.kind===f.yp.ThisRow)))||void 0===a?void 0:a.type;"block"===(null==n?void 0:n.type)&&void 0!==n.collection&&r.push(...await tt(n.collection,t,e)),t.valueTypes.forEach((t=>{if(t.kind===f.yp.ContextValue&&nt(e,t.name)){const e=(0,f.ij)(t.id);r.push({kind:f.WY.Token,token:{type:f.Oy.ContextValue,valueId:e}})}}))}else"block"===n.type?r.push(...await tt(n.collection,t,e)):"person"===n.type&&r.push(...function(e){const t=[];for(const n of Object.values(f.V2))(""===e||n.startsWith(e))&&t.push({kind:f.WY.Token,token:{type:f.Oy.UserProperty,userProperty:n}});return t}(e));for(const c in Je)if(!o.has(c)&&nt(e,c)){const e=Je[c];if(void 0!==n){var i,s,p,u,l,y;const t=(null===(i=e.parameters)||void 0===i||null===(s=i.expected)||void 0===s||null===(p=s[0])||void 0===p?void 0:p.type)??(null===(u=e.parameters)||void 0===u||null===(l=u.varargs)||void 0===l||null===(y=l[0])||void 0===y?void 0:y.type);if(void 0===t||!(0,f.qT)(n,t))continue}r.push({kind:f.WY.LibraryFunction,libraryFunction:e}),o.add(c)}return r}function ot(e,t){const n=[...e].reverse().find((e=>e.kind===s.Call));if((null==n?void 0:n.kind)===s.Call){let e=-1;if(t>n.lParenOffset&&(void 0===n.rParenOffset||t<=n.rParenOffset))for(e=0;e<n.commaOffsets.length&&!(n.commaOffsets[e]>t);e++);return{expression:n.expression,parameterIndex:e}}}async function at(e,t,n){const[o,i]=ze(e),p=function(e,t){if(0===t)return 0;let n=0,r=0;for(let o=0;o<e.length;o++){const a=e[o];switch(a.type){case"code":if(n+a.length>=t)return r+(t-n);n+=a.length,r+=a.length;break;case"token":if(n+1>=t)return r+a.length;n+=1,r+=a.length;break;default:(0,Pe.t1)(a)}}return r}(i,t);let u=o.substring(0,p);if(""===u.trim())return{value:{inputPosition:t,mappedPosition:p,completions:await rt("",n)}};const l=u[u.length-1],y=/[\s.]/.test(l);y&&(u=`${u}_`);const c=ye.tokenize(u).tokens;de.input=c;const d=ke(de.expression());if(r.x.isFail(d))return{value:void 0};const f=await He(d.value,n),{node:m}=f,h=c[c.length-1];let v=!1,x=c;void 0!==h&&(0,a.ol)(h,ue.IdentifierName)&&/\w/.test(u[u.length-1])&&(x=[...x],x.pop(),v=!0);const g=de.computeContentAssist("expression",x),b=v?h.image.substring(0,h.image.length-(y?1:0)):void 0,k=et(m,p),T={inputPosition:t,mappedPosition:p,nodePath:k,callParameter:ot(k,p)};for(const r of g)if(r.nextTokenType===ue.IdentifierName)if("dotMemberExpression"===r.ruleStack[r.ruleStack.length-1]){const e=x[x.length-1];if(!(0,a.ol)(e,ue.Dot))return{value:void 0};const t=k[k.length-1];if(void 0!==t&&(t.kind===s.UnifiedFunctionProperty||t.kind===s.MemberBlockProperty)){const e=t.expression;T.completionsInfo={type:"member dot receiver",prefix:b,receiverNode:e},T.completions=await rt(b??"",e.context,e.type)}}else{var O;T.completionsInfo={type:"free identifier",prefix:b},T.completions=await rt(b??"",(null===(O=k[k.length-1])||void 0===O?void 0:O.context)??n)}return{value:T}}function it(e){switch(e){case"checkbox":return"boolean";case"number":return"number";case"text":return"text";case"date":return"date";case"array":return"array";case"block":return"block";case"person":return"person";case"select":return"select";case"function":return"function";case"unknown":return"unknown";case"undefined":return"undefined";default:(0,Pe.t1)(e)}}function st(e){switch(e.type){case y.FunctionCallArgumentWrongType:return e.argument;default:return e.node}}function pt(e){switch(e.type){case y.ThisRowTypeNotFound:return"Cannot find this row in context";case y.ThisRowNotBlockWithCollection:return"This row is not a block with a collection";case y.MissingPropertyOnThisRow:return`Cannot find property ${e.token.property} on this row`;case y.MissingContextVariable:return`Cannot find context variable ${e.token.valueId}`;case y.MissingBlockValue:return`Could not find block ${e.token.blockId}`;case y.NonMemberUserProperty:return`Trying to access user property ${e.token.userProperty} on non-user`;case y.CallingNotFunction:return`Cannot call expression of type ${it(e.callee.type.type)}`;case y.FunctionCallTooFewArguments:return`Function ${e.libraryFunction.name} expects ${e.minNumParameters} arguments, but only ${e.numArguments} were provided`;case y.FunctionCallUnexpectedArgument:return`Function ${e.libraryFunction.name} received unexpected argument`;case y.FunctionCallArgumentWrongType:return`Argument of type ${it(e.argument.type.type)} does not satisfy function ${e.libraryFunction.name}`;case y.MemberPropertyMismatchCollection:return`Token ${e.token.property} does not match block's collection`;case y.MemberPropertyMissing:return`Cannot find property ${e.token.property} on collection`;case y.MemberPropertyTargetNotBlock:return"Cannot access property on non-block";case y.MemberPropertyButtonType:return"Cannot access property of type button";case y.MemberUserPropertyTargetNotPerson:return`Cannot access user property ${e.node.userProperty} on non-person`;case y.UndefinedIdentifier:return`${e.node.text} is not defined`;case y.UnifiedFunctionCannotFindFunction:return`Cannot find function ${e.name}`;case y.UnifiedFunctionNoArguments:return`Function ${e.libraryFunction.name} does not expect any arguments`;case y.UnifiedFunctionTargetWrongType:return`Cannot call ${e.libraryFunction.name} with target of type ${it(e.expression.type.type)}`;case y.CannotRelativelyCompareTypes:return`Cannot compare ${it(e.lhsType.type)} and ${it(e.rhsType.type)}`;case y.CannotDoMathOnType:return`Cannot do math on ${it(e.lhsType.type)} and ${it(e.rhsType.type)}`;case y.UnaryMinusOnNonNumber:return`Cannot apply minus to ${it(e.expression.type.type)}`;default:(0,Pe.t1)(e)}}function ut(e){switch(e.type){case l.MissingThisRow:return"Cannot not find this row";case l.MissingSchemaPropertyOnThisRow:return`Missing property ${e.property} on this row`;case l.ThisRowBlockPropertyMismatchCollection:return"This row property has different collection";case l.MissingContextVariable:return`Missing context variable ${e.valueId}`;case l.NonMemberUserProperty:return"Cannot access user property on this row";case l.IdentifierNotFound:return`${e.node.text} is not defined`;case l.CannotRelativelyCompareTypes:return`Cannot compare ${it(e.lhsType)} and ${it(e.rhsType)}`;case l.CannotDoMathOnType:return`Cannot do math on type ${it(e.valueType)}`;case l.CannotCallNonFunction:return`Cannot call type ${it(e.calleeType)}`;case l.UnifiedFunctionPropertyNotFound:return`Function ${e.node.name} not found`;case l.LibraryFunctionExecutionError:return`Error occured while calling ${e.libraryFunction.name}`;case l.FunctionCallTooFewArguments:return`Called ${e.libraryFunction.name} with too few arguments`;case l.FunctionCallUnexpectedArgument:return`Called ${e.libraryFunction.name} with too many arguments`;case l.FunctionCallArgumentWrongType:return`Called ${e.libraryFunction.name} with wrong argument type ${it(e.argumentType)}`;case l.AccessingPropertyOnNonBlock:return"Target object is not a block";case l.AccessingUserPropertyOnNonPerson:return"Target object is not a person";case l.MissingDataDependencyBlock:return`Cannot find target block ${e.blockPointer.id}`;case l.MissingDataDependencyPerson:return`Cannot find target person ${e.personPointer.id}`;case l.MemberPropertyMismatchCollection:return"Cannot access property of a different collection";case l.MissingPropertyOnSchemaForMemberProperty:return"Cannot find property on collection";case l.UnaryMinusOnNonNumber:return`Cannot negate value of type ${e.expressionType}`;case l.UnexpectedRecoveryNode:return"Unexpected recovery node";case l.UnexpectedError:return"Unexpected error";default:(0,Pe.t1)(e)}}async function lt(e,t){const[n,o]=ze(e),[a,i]=ve(n);if(i.length>0)return{error:i[0]};const s=ke(a);return r.x.isFail(s)?s:Ke(s.value,t)}async function yt(e,t){const[n]=ze(e),[o,a]=ve(n);if(a.length>0)return{value:{parseErrors:a}};const i=ke(o);if(r.x.isFail(i))return{value:{parseErrors:[i.error]}};const s=await He(i.value,t),{node:p,errors:u}=s;return{value:{type:p.type,typeErrors:u}}}}}]);